<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Git foundations &mdash; pydagogue 0.2 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="pydagogue 0.2 documentation" href="index.html" />
    <link rel="next" title="What is a decorator?" href="decorating_for_dummies.html" />
    <link rel="prev" title="Welcome to Pydagogue" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="decorating_for_dummies.html" title="What is a decorator?"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to Pydagogue"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">pydagogue 0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="git-foundations">
<span id="git-foundation"></span><h1>Git foundations<a class="headerlink" href="#git-foundations" title="Permalink to this headline">¶</a></h1>
<p>&#8220;Foundations&#8221; is a little joke on a religious theme; our page borrows heavily
from the <a class="reference external" href="http://tom.preston-werner.com/2009/05/19/the-git-parable.html">git parable</a> - so - why not a foundation myth?</p>
<div class="section" id="on-the-first-day-the-repository-and-the-working-tree">
<h2>On the first day - the repository and the working tree<a class="headerlink" href="#on-the-first-day-the-repository-and-the-working-tree" title="Permalink to this headline">¶</a></h2>
<p>I&#8217;m young and the world is fresh and I have lots of time.</p>
<p>I have so much time, that I decide that I want to write a book.  The project I
am working on is a modest history and explanation of everything, with
provisional title &#8220;The Book&#8221;.  It has a table of contents <tt class="docutils literal"><span class="pre">contents.txt</span></tt> and a
single book chapter:</p>
<div class="highlight-python"><div class="highlight"><pre>.
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>As I start to write, I begin to think I should keep track of my changes.  I need
some sort of version control system.  How hard can it be?</p>
<p>I start with some names.  I&#8217;m going to call this set of files that I&#8217;m working
on, the <em>working tree</em>. Because I currently lack any shame about body issues, I
will call my new versioning system <tt class="docutils literal"><span class="pre">ahole</span></tt> <a class="footnote-reference" href="#ahole-git" id="id1">[1]</a> .</p>
<p>I decide that I need to store the state of The Book at the end of each
day.  To do this, I make a new directory in my working tree, called <tt class="docutils literal"><span class="pre">.ahole</span></tt>.
This directory will store The Book as it evolves into a world-wide best-seller.
I will use the name <em>repository</em> for the contents of <tt class="docutils literal"><span class="pre">.ahole</span></tt>.</p>
<p>At the end of the day, I make a copy of all the files in the working tree, and
save it in my new <tt class="docutils literal"><span class="pre">.ahole</span></tt> repository.  In fact, what I will do is, make a new
subdirectory in <tt class="docutils literal"><span class="pre">.ahole</span></tt> named for today&#8217;s date, then store a copy of the book
files in there.  On unix, that might look like this:</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir .ahole/year0-jan-01
mkdir .ahole/year0-jan-01/files
cp * .ahole/year0-jan-01/files
</pre></div>
</div>
<p>So I&#8217;ve still got the contents of The Book in the working tree, but now, in the
repository, I have a copy of the files that is a snapshot of The Book as of
today:</p>
<div class="highlight-python"><div class="highlight"><pre>.
├── .ahole
│   └── year0-jan-01
│       └── files
│           ├── chapter1.txt
│           └── contents.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
</div>
<div class="section" id="on-the-second-day-staging-and-commits">
<h2>On the second day - staging and commits<a class="headerlink" href="#on-the-second-day-staging-and-commits" title="Permalink to this headline">¶</a></h2>
<p>Today I do some more work on the book.   I start work on chapter 2, and, while
I&#8217;m thinking about things, I find that I am also writing some notes to myself
about this character &#8220;Eve&#8221; that I have seen wandering around.  I save those
notes in a file called <tt class="docutils literal"><span class="pre">something_about_eve.txt</span></tt>.  When I get to the end of
the day, I get ready to store my work.  At the moment, my directory looks like
this:</p>
<div class="highlight-python"><div class="highlight"><pre>.
├── .ahole
│   └── year0-jan-01
│       └── files
│           ├── chapter1.txt
│           └── contents.txt
├── something_about_eve.txt
├── chapter2.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>For some reason I can&#8217;t put my finger on, I don&#8217;t want to put
<tt class="docutils literal"><span class="pre">something_about_eve.txt</span></tt> into the repository at the moment.  In fact, in
general, I want to choose which changes I back up into the repository, and which
changes I leave for another day.  In the end I come up with an idea.  I&#8217;ll make
a directory in <tt class="docutils literal"><span class="pre">.ahole</span></tt> called <tt class="docutils literal"><span class="pre">staging_area</span></tt>.  When I start work at the
beginning of the day, I copy the previous backed-up version of my files from the
repository, into <tt class="docutils literal"><span class="pre">staging_area</span></tt>. These files are now ready for storing in the
next snapshot:</p>
<div class="highlight-python"><div class="highlight"><pre>cp .ahole/year0-jan-01/* .ahole/staging_area
</pre></div>
</div>
<p>I now have:</p>
<div class="highlight-python"><div class="highlight"><pre>├── .ahole
│   ├─── staging_area
│   │    ├── chapter1.txt
│   │    └── contents.txt
│   └── year0-jan-01
│       └── files
│           ├── chapter1.txt
│           └── contents.txt
├── something_about_eve.txt
├── chapter2.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>As I work, I decide what I&#8217;m going to put into tonight&#8217;s snapshot.  For example,
maybe I changed <tt class="docutils literal"><span class="pre">chapter1.txt</span></tt> and I think it&#8217;s ready to back up. I copy my
modified version of <tt class="docutils literal"><span class="pre">chapter1.txt</span></tt> from the working tree to <tt class="docutils literal"><span class="pre">staging_area</span></tt>.
I&#8217;ll call that <em>stage</em>-ing the file.  I&#8217;ll also &#8216;stage&#8217; the new <tt class="docutils literal"><span class="pre">chapter2.txt</span></tt>
file (copy it to the staging area).  I&#8217;m not going to stage
<tt class="docutils literal"><span class="pre">something_about_eve.txt</span></tt> at the moment.</p>
<p>Now I&#8217;ve done that, all the stuff I want to store in the backup is ready.  I
just need to put it into its own backup snapshot directory.   To do that, I just
do something like (Unix again):</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir .ahole/year0-jan-02
mkdir .ahole/year0-jan-02/files
cp .ahole/staging_area/* .ahole/year0-jan-02/files
</pre></div>
</div>
<p>I end up with a directory that looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre>.
├── .ahole
│   ├── year0-jan-02
│   │   └── files
│   │       ├── chapter2.txt
│   │       ├── chapter1.txt
│   │       └── contents.txt
│   ├─── staging_area
│   │    ├── chapter2.txt
│   │    ├── chapter1.txt
│   │    └── contents.txt
│   └── year0-jan-01
│       └── files
│           ├── chapter1.txt
│           └── contents.txt
├── something_about_eve.txt
├── chapter2.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>I decide that I&#8217;ll use the name <em>commit</em> for each of the daily snapshot
directories (<tt class="docutils literal"><span class="pre">year0-jan-01</span></tt> and <tt class="docutils literal"><span class="pre">year0-jan-02</span></tt>).  The action of adding files
to the staging area, I will call <em>staging</em> files for the commit.  I will use
the term <em>committing</em> for the action of making the snapshot directory, and
copying the files from the staging area to the snapshot directory.</p>
</div>
<div class="section" id="on-the-third-day-history">
<h2>On the third day - history<a class="headerlink" href="#on-the-third-day-history" title="Permalink to this headline">¶</a></h2>
<p>As a result of certain events yesterday evening, I have a new friend, Eve.  She
wants to help out.  Of course Eve has her own computer, and I send her my
<tt class="docutils literal"><span class="pre">.ahole</span></tt> directory.  I thank myself for my wisdom in not adding
<tt class="docutils literal"><span class="pre">something_about_eve.txt</span></tt> to the repository.</p>
<p>Eve checks out our book (reconstructs my working tree) with something like:</p>
<div class="highlight-python"><div class="highlight"><pre>cp .ahole/year0-jan-02/files/* .
</pre></div>
</div>
<p>Now she&#8217;s got the book files as I committed them last night.  She also copies
the last commit files into the staging area, as I did:</p>
<div class="highlight-python"><div class="highlight"><pre>├── .ahole
│   ├─── staging_area
│   │    ├── chapter2.txt
│   │    ├── chapter1.txt
│   │    └── contents.txt
</pre></div>
</div>
<p>She works hard on a new file <tt class="docutils literal"><span class="pre">chapter1_discussion.txt</span></tt>. It&#8217;s good to see she&#8217;s
enjoying the work.  As the afternoon turns to evening, she gets ready to save
her work, so she copies <tt class="docutils literal"><span class="pre">chapter1_discussion.txt</span></tt> to <tt class="docutils literal"><span class="pre">.ahole/staging_area</span></tt>.
Now she is ready to do a commit:</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir .ahole/year0-jan-03
mkdir .ahole/year0-jan-03/files
cp .ahole/staging_area/* .ahole/year0-jan-03/files
</pre></div>
</div>
<p>That is what Eve was going to do, but Eve is smart, and she immediately realizes
that there is a problem.  After she has done her commit, both of us will likely
have a commit directory <tt class="docutils literal"><span class="pre">.ahole/year0-jan-03</span></tt> - but they will have different
contents.   If she later wants to share work with me, that could get confusing.</p>
<p>The two of us are a little tired after all our work, and we meet for a beer.  We
talk about it for a while.  At first we think we can just add the time to the
date, because that&#8217;s likely to be unique for each of us.  Then we realize that
that&#8217;s going to get messy too, because, if Eve does a commit on her computer,
then I do a commit on mine, and she does another one on hers, the times will say
that these are all in one sequence, but in fact there are two sequences, mine,
and Eves.  We need some other way to keep track of the sequence of commits, that
will work even if two of us are working independently.</p>
<p>In the end we decide that we are going to give the commits some unique
identifier string instead of the date.  We might have a problem in making sure
that the unique identifier string is actually unique, but let&#8217;s assume we can
solve that somehow.  We&#8217;ll store the contents of the working tree in the same
way as we have done up till now, in the <tt class="docutils literal"><span class="pre">files</span></tt> subdirectory, but we&#8217;ll add a
new file to each commit, called <tt class="docutils literal"><span class="pre">info.txt</span></tt>, that will tell us who did the
commit, and when, and, most importantly, what the previous commit was.  We&#8217;ll
call the previous commit the <em>parent</em>.</p>
<p>Eve was right to predict that I had made my own commit today.  I&#8217;ve been happily
working on chapter 3.  So, before our conversation, my directory looked like
this:</p>
<div class="highlight-python"><div class="highlight"><pre>.
├── .ahole
│   ├── year0-jan-03
│   │   └── files
│   │       ├── chapter3.txt
│   │       ├── chapter2.txt
│   │       ├── chapter1.txt
│   │       └── contents.txt
│   ├─── staging_area
│   │    ├── chapter3.txt
│   │    ├── chapter2.txt
│   │    ├── chapter1.txt
│   │    └── contents.txt
│   ├── year0-jan-02
│   │   └── files
│   │       ├── chapter2.txt
│   │       ├── chapter1.txt
│   │       └── contents.txt
│   └── year0-jan-01
│       └── files
│           ├── chapter1.txt
│           └── contents.txt
├── something_about_eve.txt
├── chapter3.txt
├── chapter2.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>but now we&#8217;ve worked out the new way, it looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre>.
├── .ahole
│   ├── 5d89f8
│   │   ├── info.txt
│   │   └── files
│   │       ├── chapter3.txt
│   │       ├── chapter2.txt
│   │       ├── chapter1.txt
│   │       └── contents.txt
│   ├─── staging_area
│   │    ├── chapter3.txt
│   │    ├── chapter2.txt
│   │    ├── chapter1.txt
│   │    └── contents.txt
│   ├── 7ef41f
│   │   ├── info.txt
│   │   └── files
│   │       ├── chapter2.txt
│   │       ├── chapter1.txt
│   │       └── contents.txt
│   └── 6438a4
│       ├── info.txt
│       └── files
│           ├── chapter1.txt
│           └── contents.txt
├── something_about_eve.txt
├── chapter3.txt
├── chapter2.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>and <tt class="docutils literal"><span class="pre">.ahole/5d89f8/info.txt</span></tt> looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre>committer = Adam
message = Third day
date = year0-jan-03
parent = 7ef41f
</pre></div>
</div>
<p>Meanwhile, Eve&#8217;s directory looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre>.
├── .ahole
│   ├── 0a01a0
│   │   ├── info.txt
│   │   └── files
│   │       ├── chapter1_discussion.txt
│   │       ├── chapter2.txt
│   │       ├── chapter1.txt
│   │       └── contents.txt
│   ├─── staging_area
│   │    ├── chapter1_discussion.txt
│   │    ├── chapter2.txt
│   │    ├── chapter1.txt
│   │    └── contents.txt
│   ├── 7ef41f
│   │   ├── info.txt
│   │   └── files
│   │       ├── chapter2.txt
│   │       ├── chapter1.txt
│   │       └── contents.txt
│   └── 6438a4
│       ├── info.txt
│       └── files
│           ├── chapter1.txt
│           └── contents.txt
├── chapter1_discussion.txt
├── chapter2.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>and Eve&#8217;s <tt class="docutils literal"><span class="pre">.ahole/0a01a0/info.txt</span></tt> looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre>committer = Eve
message = Eve day 3
date = year0-jan-03
parent = 7ef41f
</pre></div>
</div>
<p>After a little thought, Eve and I realize that, when we make our new commit, we
are going to have to know what the current commit is, so we can use that as the
parent.  When we make a new commit, we store the commit identifier in a file.
We&#8217;ll call this file <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt>, so, after my last commit above, the file
<tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt> will have the contents <tt class="docutils literal"><span class="pre">5d89f8</span></tt>. We use the contents of
<tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt> to identify the last (current) commit.  And of course, when we
make a new commit, we can get the parent of the new commit, from the current
commit in <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt>.</p>
<p>So now, we have a new procedure for our commit.  In outline it looks like this
(now in <a class="reference external" href="http://www.python.org">python</a> syntax) <a class="footnote-reference" href="#commit-imports" id="id2">[2]</a></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">ahole_commit</span><span class="p">(</span><span class="n">committer</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="c"># Make a unique identifier for this commit somehow</span>
    <span class="n">new_id</span> <span class="o">=</span> <span class="n">make_unique_id</span><span class="p">()</span>
    <span class="c"># Make a new directory in ahole with the new unique name</span>
    <span class="n">commit_dir</span> <span class="o">=</span> <span class="s">&#39;.ahole/&#39;</span> <span class="o">+</span> <span class="n">new_id</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">commit_dir</span><span class="p">)</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s">&#39;/files&#39;</span><span class="p">)</span>
    <span class="c"># Copy the files from the staging area to the new snapshot directory</span>
    <span class="n">copy_tree</span><span class="p">(</span><span class="s">&#39;.ahole/staging_area&#39;</span><span class="p">,</span> <span class="n">commit_dir</span> <span class="o">+</span> <span class="s">&#39;/files&#39;</span><span class="p">)</span>
    <span class="c"># Get previous (parent) commit id from .ahole/HEAD</span>
    <span class="n">head_id</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="s">&#39;.ahole/HEAD&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="c"># Make info with parent set to HEAD</span>
    <span class="n">info_str</span> <span class="o">=</span> <span class="s">&#39;committer = &#39;</span> <span class="o">+</span> <span class="n">committer</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s">&#39;message = &#39;</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s">&#39;date = &#39;</span> <span class="o">+</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s">&#39;parent = &#39;</span> <span class="o">+</span> <span class="n">head_id</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="c"># Write info to info.txt file</span>
    <span class="n">info_file</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s">&#39;/info.txt&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">info_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">info_str</span><span class="p">)</span>
    <span class="n">info_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c"># Set .ahole/HEAD to contain new commit id</span>
    <span class="nb">file</span><span class="p">(</span><span class="s">&#39;.ahole/HEAD&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_id</span><span class="p">)</span>
</pre></div>
</div>
<p>When we want to go back to an earlier state of the book, we can do a
<em>checkout</em>, with something like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">ahole_checkout</span><span class="p">(</span><span class="n">commit_id</span><span class="p">):</span>
    <span class="n">commit_dir</span> <span class="o">=</span> <span class="s">&#39;.ahole/&#39;</span> <span class="o">+</span> <span class="n">commit_id</span>
    <span class="c"># copy .ahole/:math:`commit_id/files into working tree</span>
    <span class="n">delete_tree</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">copy_tree</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s">&#39;/files&#39;</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="c"># make .ahole/HEAD contain commit_id</span>
    <span class="nb">file</span><span class="p">(</span><span class="s">&#39;.ahole/HEAD&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">commit_id</span><span class="p">)</span>
    <span class="c"># copy commit snapshot into staging area</span>
    <span class="n">delete_tree</span><span class="p">(</span><span class="s">&#39;.ahole/staging_area&#39;</span><span class="p">)</span>
    <span class="n">copy_tree</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s">&#39;/files&#39;</span><span class="p">,</span> <span class="s">&#39;.ahole/staging_area&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>So, when we run <tt class="docutils literal"><span class="pre">ahole_checkout('7ef41f`)</span></tt> we will get the copy of the working
tree corresponging to <tt class="docutils literal"><span class="pre">7ef41f</span></tt>, and <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt> will just contain the
string <tt class="docutils literal"><span class="pre">7ef41f</span></tt>.</p>
<p>In our excitement, we immediately realize that it&#8217;s really easy to see the
history of the book now.  We can easily fetch out <tt class="docutils literal"><span class="pre">info.txt</span></tt> from the current
commit, print it, then find its parent, and fetch <tt class="docutils literal"><span class="pre">info.txt</span></tt> from the parent,
print it, and so on.</p>
<p>Now we are tired, but happy, and we rest.</p>
</div>
<div class="section" id="on-the-fourth-day-references">
<h2>On the fourth day - references<a class="headerlink" href="#on-the-fourth-day-references" title="Permalink to this headline">¶</a></h2>
<p>We wake with a strange excitement.  The idea, of keeping a reference to the
current commit in <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt>, seems that it could be more general.  I
talk to Eve over breakfast (she stayed in her own place of course, but she came
over for work).  Together we work out the concept of <em>references</em>. A reference
is:</p>
<dl class="docutils">
<dt>Reference</dt>
<dd>Something that points to a commit</dd>
</dl>
<p>So, <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt> is a reference - to the current commit.  But what if I decide
that I want to give out some preliminary version of our book.  Let&#8217;s say I want
to release the book stored in <tt class="docutils literal"><span class="pre">.ahole/7ef41f/files</span></tt> as &#8216;release-0.1&#8217;.   I&#8217;m
going to send this out to all my friends (to be honest, I don&#8217;t have many
friends just yet, but still).  I want to be able to remember what version of the
book I sent out.  I can make a <em>reference</em> to this commit.  I&#8217;ll call this a
<em>tag</em>.   I make a new directory in <tt class="docutils literal"><span class="pre">.ahole</span></tt> called <tt class="docutils literal"><span class="pre">refs</span></tt>, and another
directory in <tt class="docutils literal"><span class="pre">refs</span></tt>, called <tt class="docutils literal"><span class="pre">tags</span></tt>, and then, in
<tt class="docutils literal"><span class="pre">.ahole/refs/tags/release-0.1</span></tt> I just put <tt class="docutils literal"><span class="pre">7ef41f</span></tt> - a reference to the
release commit.   That way, if I ever need to go back to the version of the book
I released, I just have to read the <tt class="docutils literal"><span class="pre">release-0.1</span></tt> file to find the commit, and
then checkout that commit.</p>
<p>Wait, but, there&#8217;s a problem.  If I checkout the commit in <tt class="docutils literal"><span class="pre">release-0.1</span></tt>, I
will overwrite <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt>, and I will lose track of what commit I was
working on before.</p>
<p>Let&#8217;s store that in another reference.  Let&#8217;s use the name &#8216;master&#8217; for my main
line of development.  I store where this is, by making a new file
<tt class="docutils literal"><span class="pre">.ahole/refs/heads/master</span></tt> that is a reference to the last commit.  It just
contains the text &#8216;5d89f8&#8217;.  So that I know that I am working on &#8216;master&#8217;, I
make <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt> have the text <tt class="docutils literal"><span class="pre">ref:</span> <span class="pre">refs/heads/master</span></tt>.  Now, when I make
a new commit, I first check <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt>; if I see <tt class="docutils literal"><span class="pre">ref:</span>
<span class="pre">refs/heads/master</span></tt>, then first, I get the commit id in
<tt class="docutils literal"><span class="pre">.ahole/refs/heads/master</span></tt> - and I use that as the parent id for the commit.
When I&#8217;ve saved the new commit, I set <tt class="docutils literal"><span class="pre">.ahole/refs/heads/master</span></tt> to have the
new commit id.  So, I need to modify my commit procedure slightly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">ahole_commit</span><span class="p">(</span><span class="n">committer</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="c"># *** this stuff down to the next *** line is new</span>
    <span class="c"># Get previous (parent) commit id from .ahole/HEAD</span>
    <span class="n">head_contents</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="s">&#39;.ahole/HEAD&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="c"># Check if this is a reference, de-reference if so</span>
    <span class="c"># Also, get file into which to write the new commit id</span>
    <span class="k">if</span> <span class="n">head_contents</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;ref: &#39;</span><span class="p">):</span>
        <span class="n">head_ref</span> <span class="o">=</span> <span class="n">head_contents</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;ref: &#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">head_ref_file</span> <span class="o">=</span> <span class="s">&#39;.ahole/&#39;</span> <span class="o">+</span> <span class="n">head_ref</span>
        <span class="n">head_id</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">head_ref_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">head_ref_file</span> <span class="o">=</span> <span class="s">&#39;.ahole/HEAD&#39;</span>
        <span class="n">head_id</span> <span class="o">=</span> <span class="n">head_contents</span>
    <span class="c"># *** the stuff below you&#39;ve seen before (until *** again)</span>
    <span class="c"># Make a unique identifier for this commit somehow</span>
    <span class="n">new_id</span> <span class="o">=</span> <span class="n">make_unique_id</span><span class="p">()</span>
    <span class="c"># Make a new directory in ahole with the new unique name</span>
    <span class="n">commit_dir</span> <span class="o">=</span> <span class="s">&#39;.ahole/&#39;</span> <span class="o">+</span> <span class="n">new_id</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">commit_dir</span><span class="p">)</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s">&#39;/files&#39;</span><span class="p">)</span>
    <span class="c"># Copy the files from the staging area to the new snapshot directory</span>
    <span class="n">copy_tree</span><span class="p">(</span><span class="s">&#39;.ahole/staging_area&#39;</span><span class="p">,</span> <span class="n">commit_dir</span> <span class="o">+</span> <span class="s">&#39;/files&#39;</span><span class="p">)</span>
    <span class="c"># Make info.txt with parent set to HEAD</span>
    <span class="n">info_str</span> <span class="o">=</span> <span class="s">&#39;committer = &#39;</span> <span class="o">+</span> <span class="n">committer</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s">&#39;message = &#39;</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s">&#39;date = &#39;</span> <span class="o">+</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s">&#39;parent = &#39;</span> <span class="o">+</span> <span class="n">head_id</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="c"># Write info to info.txt file</span>
    <span class="n">info_file</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s">&#39;/info.txt&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">info_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">info_str</span><span class="p">)</span>
    <span class="n">info_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c"># Set the file that points to the current commit, to point to our commit</span>
    <span class="c"># *** a little new, in that we might be writing to .ahole/HEAD, or</span>
    <span class="c"># something like .ahole/refs/heads/master, depending on what .ahole/HEAD</span>
    <span class="c"># contained at the top of this routine</span>
    <span class="nb">file</span><span class="p">(</span><span class="n">head_ref_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_id</span><span class="p">)</span>
</pre></div>
</div>
<p>So, let&#8217;s say that I&#8217;m currently on commit &#8216;5d89f8&#8217;.  <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt> contains
<tt class="docutils literal"><span class="pre">ref:</span> <span class="pre">refs/heads/master</span></tt>.  <tt class="docutils literal"><span class="pre">.ahole/refs/heads/master</span></tt> contains <tt class="docutils literal"><span class="pre">5d89f8</span></tt>.
I run my commit procedure:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ahole_commit</span><span class="p">(</span><span class="s">&#39;Adam&#39;</span><span class="p">,</span> <span class="s">&#39;Night follows day&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The commit procedure has made a new commit &#8216;dfbeda&#8217;; <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt> continues
to have text <tt class="docutils literal"><span class="pre">ref:</span> <span class="pre">refs/heads/master</span></tt>, but now <tt class="docutils literal"><span class="pre">.ahole/refs/heads/master</span></tt>
contains <tt class="docutils literal"><span class="pre">dfbeda</span></tt>.  In this way, we keep track of which commit we are on, by
constantly updating &#8216;master&#8217;.</p>
<p>Ok - now let&#8217;s return to me checking out the released version of the book.  I
first get the contents of <tt class="docutils literal"><span class="pre">.ahole/refs/tags/release-0.1</span></tt> - it&#8217;s &#8216;5d89f8&#8217;.
Then I checkout the working tree for that version, using my nice
<tt class="docutils literal"><span class="pre">ahole_checkout</span></tt> procedure:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ahole_checkout</span><span class="p">(</span><span class="s">&#39;5d89f8&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The checkout procedure will make <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt> contain the text <tt class="docutils literal"><span class="pre">5d89f8</span></tt>.</p>
<p>Now I want to go back to working on my current version of the book.  That&#8217;s the
set of files pointed to by <tt class="docutils literal"><span class="pre">.ahole/refs/heads/master</span></tt>.  I can
check the contents of <tt class="docutils literal"><span class="pre">.ahole/refs/heads/master</span></tt> - it is <tt class="docutils literal"><span class="pre">dfbeda</span></tt>.  Then I
get the current version with the normal checkout procedure:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ahole_checkout</span><span class="p">(</span><span class="s">&#39;dfbeda&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, I&#8217;ll have to set <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt> to be <tt class="docutils literal"><span class="pre">ref:</span> <span class="pre">refs/heads/master</span></tt>.  All
good.</p>
<p>Of course, I could automate this, by modifying my checkout procedure slightly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">ahole_checkout</span><span class="p">(</span><span class="n">commit_reference</span><span class="p">):</span>
   <span class="c"># If this is a reference, dereference</span>
   <span class="k">if</span> <span class="n">commit_reference</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="s">&#39;.ahole/refs/heads&#39;</span><span class="p">):</span>
       <span class="c"># it&#39;s a head reference, maybe &#39;master&#39;</span>
       <span class="n">head_reference</span> <span class="o">=</span> <span class="bp">True</span>
       <span class="n">fname</span> <span class="o">=</span> <span class="s">&#39;.ahole/refs/heads/&#39;</span> <span class="o">+</span> <span class="n">commit_reference</span>
       <span class="n">commit_id</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
   <span class="k">elif</span> <span class="n">commit_reference</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="s">&#39;.ahole/refs/tags&#39;</span><span class="p">):</span>
       <span class="c"># it&#39;s a tag reference</span>
       <span class="n">head_reference</span> <span class="o">=</span> <span class="bp">False</span>
       <span class="n">fname</span> <span class="o">=</span> <span class="s">&#39;.ahole/refs/tags/&#39;</span> <span class="o">+</span> <span class="n">commit_reference</span>
       <span class="n">commit_id</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
   <span class="k">else</span><span class="p">:</span> <span class="c"># Just a standard commit id</span>
       <span class="n">head_reference</span> <span class="o">=</span> <span class="bp">False</span>
       <span class="n">commit_id</span> <span class="o">=</span> <span class="n">commit_reference</span>
   <span class="n">commit_dir</span> <span class="o">=</span> <span class="s">&#39;.ahole/&#39;</span> <span class="o">+</span> <span class="n">commit_id</span>
   <span class="c"># copy .ahole/`commit_id/files into working tree</span>
   <span class="n">delete_tree</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
   <span class="n">copy_tree</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s">&#39;/files&#39;</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">)</span>
   <span class="c"># make ahole/HEAD point to commit id</span>
   <span class="k">if</span> <span class="n">head_reference</span><span class="p">:</span>
       <span class="c"># Point HEAD at head reference</span>
       <span class="nb">file</span><span class="p">(</span><span class="s">&#39;.ahole/HEAD&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;ref: refs/heads/&#39;</span> <span class="o">+</span> <span class="n">commit_reference</span><span class="p">)</span>
       <span class="c"># Write commit id into head reference file</span>
       <span class="nb">file</span><span class="p">(</span><span class="s">&#39;.ahole/refs/heads/&#39;</span> <span class="o">+</span> <span class="n">commit_reference</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">commit_id</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="nb">file</span><span class="p">(</span><span class="s">&#39;.ahole/HEAD&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">commit_id</span><span class="p">)</span>
   <span class="c"># copy commit snapshot into staging area</span>
   <span class="n">delete_tree</span><span class="p">(</span><span class="s">&#39;.ahole/staging_area&#39;</span><span class="p">)</span>
   <span class="n">copy_tree</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s">&#39;/files&#39;</span><span class="p">,</span> <span class="s">&#39;.ahole/staging_area&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>What then, is the difference, between a <em>tag</em> - like our release - and the
moving target like &#8216;master&#8217;?  The &#8216;tag&#8217; is a <em>static</em> reference - it does not
change when we do a commit and always points to the same commit.  &#8216;master&#8217; is a
dynamic reference - in particular, it&#8217;s a <em>head</em> reference:</p>
<dl class="docutils">
<dt>Head</dt>
<dd>A head is a reference that updates when we do a commit</dd>
</dl>
<p>My head is hurting a little, after Eve explains all this, but after a little
while and a nice apple pie, I&#8217;m feeling positive about <tt class="docutils literal"><span class="pre">ahole</span></tt>.</p>
</div>
<div class="section" id="on-the-fifth-day-branches-merges-and-remotes">
<h2>On the fifth day - branches, merges and remotes<a class="headerlink" href="#on-the-fifth-day-branches-merges-and-remotes" title="Permalink to this headline">¶</a></h2>
<p>Yesterday was a little exhausting, so today there was some time for reflection.</p>
<p>As Eve and I relax with the other animals, who are all getting on very well with
each other, we begin to realize that this <em>head</em> thing could be very useful.</p>
<p>For example, what if one of my very small number of friends tells me that
there&#8217;s a serious conceptual error in the version of the book that I released -
&#8216;release-0.1&#8217;.  What if I want to go back and fix it - that is - do another
commit on top of the <em>released</em> book, instead of the version of the book that
I&#8217;m currently working on?  I can just make a new <em>head</em>.  I&#8217;ll do it like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">cp</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">tags</span><span class="o">/</span><span class="n">release</span><span class="o">-</span><span class="mf">0.1</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">working</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="mf">0.1</span>
</pre></div>
</div>
<p>Then, I look at what commit <tt class="docutils literal"><span class="pre">working-on-0.1</span></tt> contains - of course it&#8217;s
<tt class="docutils literal"><span class="pre">7ef41f</span></tt>.  I get that state of the book with my new checkout procedure:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ahole_checkout</span><span class="p">(</span><span class="s">&#39;working-on-0.1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This changes <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt> to be <tt class="docutils literal"><span class="pre">ref:</span> <span class="pre">refs/heads/working-on-0.1</span></tt>.  Now,
when I do a commit with <tt class="docutils literal"><span class="pre">ahole_commit</span></tt>,  that will update the file
<tt class="docutils literal"><span class="pre">.ahole/refs/heads/working-on-0.1</span></tt> to have the new commit identifier.  Despite the
apple pie being a bit bitter last night, we&#8217;re feeling good.</p>
<p>As we think about this, we come to think of &#8216;master&#8217; and &#8216;working-on-0.1&#8217; as
<em>branches</em> - because they can each be thought of as identifying a tree or graph
of commits, which can grow.  All I need, to make a new branch, is make a
new head reference to a commit.  For example, if I want to make new branch
starting at the current position of &#8216;master&#8217;, all I need is:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">cp</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">tags</span><span class="o">/</span><span class="n">master</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">my</span><span class="o">-</span><span class="n">new</span><span class="o">-</span><span class="n">branch</span>
</pre></div>
</div>
<p>If I want to work on this branch, I need to check it out, with:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ahole_checkout</span><span class="p">(</span><span class="s">&#39;my-new-branch&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>That will get the commit identifier in <tt class="docutils literal"><span class="pre">.ahole/refs/heads/my-new-branch</span></tt>, unpack
the commit tree into the working tree, and set <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt> to contain the
text <tt class="docutils literal"><span class="pre">ref:</span> <span class="pre">refs/heads/my-new-branch</span></tt></p>
<p>I&#8217;ve got my branches, but Eve will have her own branches, and this will help us
know where each of us is working.</p>
<p>That&#8217;s good, because Eve is now asking me if I can have a look at her changes,
and whether I&#8217;ll include them in my version of the book.  Unwisely I end up
suggesting that women don&#8217;t contribute to books, and ask her why her hair isn&#8217;t
covered with an as-yet not-invented headscarf.  In the end we patch it up, and I
agree to go back and try and put in her changes.</p>
<p>Luckily, despite the lack of basics like clothing, there is an excellent local
network, so I can see the contents of her version of the book at
<tt class="docutils literal"><span class="pre">/eves_computer/our_book/.ahole</span></tt>.  She wants me to look at her &#8216;master&#8217;
branch.  Just because the network might fail, I need to fetch what I need from
her computer to mine.  So, to keep track of things, I&#8217;ll make a new directory,
called <tt class="docutils literal"><span class="pre">.ahole/refs/remotes/eve</span></tt>, and I&#8217;ll copy all her <em>heads</em> - in this case
just <tt class="docutils literal"><span class="pre">master</span></tt> - to that directory.   So now, I&#8217;ve got
<tt class="docutils literal"><span class="pre">.ahole/refs/remotes/eve/master</span></tt>, and in fact, it points to the commit that
she did on the third day; this was commit &#8216;0a01a0&#8217;.  I don&#8217;t have this
commit in my <tt class="docutils literal"><span class="pre">.ahole</span></tt> directory, so I&#8217;ll copy that from
<tt class="docutils literal"><span class="pre">/eves_computer/our_book/.ahole/0a01a0</span></tt>.  I look in the <tt class="docutils literal"><span class="pre">info.txt</span></tt> file
for that commit, and check what the parent is.  It is &#8216;7ef41f&#8217;.  I check if I
have that, and yes, I have, so I can stop copying stuff from Eve&#8217;s directory.</p>
<p>So, what I just did was:</p>
<ul class="simple">
<li>Copy Eve&#8217;s <em>head</em> references from
<tt class="docutils literal"><span class="pre">/eves_computer/our_book/.ahole/refs/heads</span></tt> to my
<tt class="docutils literal"><span class="pre">.ahole/refs/remotes/eve</span></tt>.</li>
<li>For each of the references in <tt class="docutils literal"><span class="pre">.ahole/refs/remotes/eve</span></tt>, I check whether
I have the referenced commit, and the parents of that commit, and, if not, I
copy them to <tt class="docutils literal"><span class="pre">.ahole</span></tt>.</li>
</ul>
<p>We decide to call that two-step sequence - a <em>fetch</em>.</p>
<p>Now I want to look at her version of the book.  I have her head references and
the commits they point to, so I can checkout her latest version. I first get the
commit identifier from <tt class="docutils literal"><span class="pre">.ahole/refs/remotes/eve/master</span></tt> - &#8216;0a01a0&#8217;.  Then:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ahole_checkout</span><span class="p">(</span><span class="s">&#39;0a01a0&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This will put &#8216;0a01a0&#8217; into <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt>.  I can look at her version of the
book, and decide if I like it.  If I do, then I can do a <em>merge</em>.</p>
<p>What is a merge?  It&#8217;s the join of two commits.  First I work out where Eve&#8217;s
tree diverged from mine, by going back in her history, following the parents of
the commits.  In this case it&#8217;s easy, because the parent commit (&#8216;7ef41f&#8217;) of
this commit (&#8216;0a01a0&#8217;) is one that is also in my history (the history for my
&#8216;master&#8217; branch).  This most recent shared commit I will call the <em>common
ancestor</em>.  Then I work out the difference between the common ancestor commit
(&#8216;7ef41f&#8217;) and this commit (&#8216;0a01a0&#8217;) - let&#8217;s call that <tt class="docutils literal"><span class="pre">eves_diff</span></tt>.</p>
<p>I go back to my own &#8216;master&#8217; - which turns out to be
(<tt class="docutils literal"><span class="pre">.ahole/refs/heads/master</span></tt>) - &#8216;dfbeda&#8217;:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ahole_checkout</span><span class="p">(</span><span class="s">&#39;master&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This will change <tt class="docutils literal"><span class="pre">.ahole/HEAD</span></tt> to be <tt class="docutils literal"><span class="pre">ref:</span> <span class="pre">refs/heads/master</span></tt> - and I will
have just got the working tree from <tt class="docutils literal"><span class="pre">.ahole/dfbeda/files</span></tt>.  Then I take
<tt class="docutils literal"><span class="pre">eves_diff</span></tt> and apply it to my current working tree.  If there were any
conflicts, I resolve them, but in my world, there are no conflicts.  I have a
feeling there may be some later.   That apple pie is making me feel a little
funny.</p>
<p>Finally, I make a new commit, with a new unique ID - say &#8216;80cc85&#8217;, with the
merged working tree.  But, there&#8217;s a trick: here the new commit &#8216;80cc85&#8217; - has
<em>two</em> parents, first - &#8216;dfbeda&#8217; - the previous commit in my &#8216;master&#8217;, and second
&#8216;0a01a0&#8217; - the last commit in Eve&#8217;s master.  Now, the next time I look at Eve&#8217;s
tree, I will be able to see that I&#8217;ve got her &#8216;0a01a0&#8217; commit in my own history,
and won&#8217;t need to apply it again.</p>
</div>
<div class="section" id="on-the-sixth-day-saving-time-and-space-with-objects">
<h2>On the sixth day - saving time and space with objects<a class="headerlink" href="#on-the-sixth-day-saving-time-and-space-with-objects" title="Permalink to this headline">¶</a></h2>
<p>I am now very happy with <tt class="docutils literal"><span class="pre">ahole</span></tt>, but Eve clearly doesn&#8217;t think we&#8217;ve got it
right yet.</p>
<p>As she&#8217;s thinking, she decides to make a couple of illustrations for The Book,
so she adds some photos to her working tree:</p>
<div class="highlight-python"><div class="highlight"><pre>.
├── .ahole
│   ...
├── images
│   ├── adam_with_apple.jpg
│   └── lion_with_lamb.jpg
├── chapter1_discussion.txt
├── chapter2.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>As soon as she does this, she realizes what&#8217;s wrong with <tt class="docutils literal"><span class="pre">ahole</span></tt>.  The photos
are large files.  At the moment, every time we make a commit, we&#8217;re copying all
the files into the commit <tt class="docutils literal"><span class="pre">files</span></tt> directory to make the snapshot.  With big
files, this is going to lead to many identical copies and lots of wasted space.</p>
<p>Eve realizes that what we need to do, is to make the commit use <em>references</em> to
files, rather than the files themselves.  That way, when the commit has files
that have not changed, it can just point to the unchanged file, rather than
carrying a wasteful copy of the file.</p>
<p>If the commits just store references, we need a way to store the contents of the
files, so they can be referenced.  Maybe we could store the files for our
snapshots in a directory, and use some sort of unique filename so that the
commits can reference that filename?  For example, maybe we could make a
directory in <tt class="docutils literal"><span class="pre">.ahole</span></tt> like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">mkdir</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">objects</span>
</pre></div>
</div>
<p>and use this directory to store the contents of the files for our snapshots.
Then we could store the commits as something like a table, where the entries
would tell us how to get the matching files from the <tt class="docutils literal"><span class="pre">.ahole/objects</span></tt>
directory.</p>
<p>We could have some structure for the commits like this:</p>
<div class="highlight-python"><div class="highlight"><pre>├── .ahole
│   ├── 5d89f8
│   │   ├── info.txt
│   │   └── file_list
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">.ahole/5d89f8/file_list</span></tt> would be a list of references to files in the
<tt class="docutils literal"><span class="pre">.ahole/objects</span></tt> directory, along with the filename that the contents has when
reconstructed back into the snapshot.  For example, maybe <tt class="docutils literal"><span class="pre">file_list</span></tt> would
have a series of (object reference, filename) pairs like this:</p>
<div class="highlight-python"><div class="highlight"><pre>contents_version1            contents.txt
chapter1_version1            chapter1.txt
chapter2_version2            chapter2.txt
chapter3_version1            chapter3.txt
chapter1_discussion_version1 chapter1_discussion.txt
</pre></div>
</div>
<p>These references in the first column could match filenames in the
<tt class="docutils literal"><span class="pre">.ahole/objects</span></tt> directory:</p>
<div class="highlight-python"><div class="highlight"><pre>│   ├── objects
│   │   ├── chapter1_version1
│   │   ├── chapter2_version1
│   │   ├── chapter2_version2
│   │   ├── chapter3_version1
│   │   ├── chapter1_discussion_version1
│   │   └── contents_version1
</pre></div>
</div>
<p>We could think of the <tt class="docutils literal"><span class="pre">.ahole/objects</span></tt> directory as a very simple form of
database, where the keys are the filenames, and the file contents are the
values.</p>
<p>We think about this for a while and realize that it&#8217;s going to be annoying
trying to find unique names to use as filenames in <tt class="docutils literal"><span class="pre">.ahole/objects</span></tt>, because
there will be many versions of many files.  For example <tt class="docutils literal"><span class="pre">chapter1_version2</span></tt>,
<tt class="docutils literal"><span class="pre">chapter1_version3</span></tt> and so on is clearly not going to work, because when Eve
and I work independently, at some point we&#8217;re both going to have something like
a <tt class="docutils literal"><span class="pre">chapter1_version3</span></tt> in our respective <tt class="docutils literal"><span class="pre">.ahole/objects</span></tt> directories, but
they will be different, and that will be confusing.</p>
<p>At this stage, Eve reveals that she has some training in computer science.  Of
course I have no idea what that is, or who did the training, but she&#8217;s in too
much of a rush to explain that now.   She proposes that we make the filenames
(database keys) by doing <em>hashes</em> of the file contents.  It turns out that
hashing algorithms can take a stream of bytes such as the contents of a file,
and create a string that is near-enough unique to that stream of bytes. That&#8217;s
really good, because it means that, if Eve and I have an object with the same
filename (hash) that means it almost certainly contains the exact same contents.</p>
<p>Eve recommends the &#8216;SHA1&#8217; hashing algorithm, and I&#8217;m in no position to disagree
with her.  Now we&#8217;ve got a unique string to use as a key for each file.  For
example, we run the SHA1 algorithm over the current book files and we get these:</p>
<table border="1" class="docutils">
<colgroup>
<col width="38%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Filename</th>
<th class="head">SHA1 hash</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>chapter1.txt</td>
<td>9e398c7cf8d56e960aa7769839cc0c38b8e12f11</td>
</tr>
<tr class="row-odd"><td>chapter2.txt</td>
<td>65735b3705284cdf4a66c2e4812ca13cbaa7cd5d</td>
</tr>
<tr class="row-even"><td>chapter1_discussion.txt</td>
<td>3c2e09cc43568f13444c075c84b047957f7995a5</td>
</tr>
<tr class="row-odd"><td>contents.txt</td>
<td>f31bfa1225f9e0eb6741a0ab1122f8cd2cbedc04</td>
</tr>
</tbody>
</table>
<p>If we change the file at all, then the hash changes, and we have a new unique
string and therefore we have a new unique filename with which to store the new
contents. For example, the original version of chapter 2 was a bit shorter, and
had a hash of &#8216;1cf01a1dfbe135b6132362fa8e17eaefcaf00a7f&#8217;.</p>
<p>Now we have got a nice way of making the references that will go into
<tt class="docutils literal"><span class="pre">.ahole/5d89f8/file_list</span></tt>.  First we store the file versions in our
<tt class="docutils literal"><span class="pre">.ahole/objects</span></tt> directory, using their hash values as filenames:</p>
<div class="highlight-python"><div class="highlight"><pre>│   ├── objects
│   │   ├── 9e398c7cf8d56e960aa7769839cc0c38b8e12f11 (chapter1 version 1)
│   │   ├── 1cf01a1dfbe135b6132362fa8e17eaefcaf00a7f (chapter2 version 1)
│   │   ├── 65735b3705284cdf4a66c2e4812ca13cbaa7cd5d (chapter2 version 2)
│   │   ├── 3c2e09cc43568f13444c075c84b047957f7995a5 (chapter1_discussion version 1)
│   │   └── f31bfa1225f9e0eb6741a0ab1122f8cd2cbedc04 (contents version 1)
</pre></div>
</div>
<p>Next we create <tt class="docutils literal"><span class="pre">.ahole/5d89f8/file_list</span></tt> with one row per file in our
directory.  Each row contains first - the hash value (and therefore filename in
<tt class="docutils literal"><span class="pre">.ahole/objects</span></tt>) which allows me to get the file contents, then the type of
thing this is - here a file - and lastly, the filename as it was in the
snapshot:</p>
<div class="highlight-python"><div class="highlight"><pre>9e398c7cf8d56e960aa7769839cc0c38b8e12f11 file chapter1.txt
65735b3705284cdf4a66c2e4812ca13cbaa7cd5d file chapter2.txt
3c2e09cc43568f13444c075c84b047957f7995a5 file chapter1_discussion.txt
f31bfa1225f9e0eb6741a0ab1122f8cd2cbedc04 file contents.txt
</pre></div>
</div>
<p>Now, what about Eve&#8217;s new working tree with the photos in it?  The photos are in
the <tt class="docutils literal"><span class="pre">images</span></tt> subdirectory, and we don&#8217;t have a way of storing subdirectories
yet.  Aha - why not store directories in the object database too?  Directories
can just be <em>tree</em> files like <tt class="docutils literal"><span class="pre">file_list</span></tt>.  <em>tree</em> files are lists, one entry
per row, where each row contains the hash reference for the file contents, the
type of thing it is (tree or file), and the filename as it was in the snapshot.
So, for Eve&#8217;s new commit, we&#8217;d first store the contents of the two photo files
in the <tt class="docutils literal"><span class="pre">.ahole/objects</span></tt> directory:</p>
<div class="highlight-python"><div class="highlight"><pre>│   ├── objects
│   │   ├── 82e6792faa893070dcd6fe3e614b6f147be1a0a9 (adam_with_apple.jpg)
│   │   ├── e8b23357995db47e70906d4c7a08114c0c0ba376 (lion_with_lamb.jpg)
│   │   ├── 9e398c7cf8d56e960aa7769839cc0c38b8e12f11 (chapter1 version 1)
</pre></div>
</div>
<p>etc.  Then we make a new <em>tree</em> file called - say - &#8216;images_listing&#8217; like this:</p>
<div class="highlight-python"><div class="highlight"><pre>82e6792faa893070dcd6fe3e614b6f147be1a0a9 file adam_with_apple.jpg
e8b23357995db47e70906d4c7a08114c0c0ba376 file lion_with_lamb.jpg
</pre></div>
</div>
<p>and we make a hash for that tree file too, and put that into
<tt class="docutils literal"><span class="pre">.ahole/objects</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>│   ├── objects
│   │   ├── be242dba385bc0689be16454e959f4b64c87abce (images_listing)
│   │   ├── 82e6792faa893070dcd6fe3e614b6f147be1a0a9 (adam_with_apple.jpg)
│   │   ├── e8b23357995db47e70906d4c7a08114c0c0ba376 (lion_with_lamb.jpg)
│   │   ├── 9e398c7cf8d56e960aa7769839cc0c38b8e12f11 (chapter1 version 1)
</pre></div>
</div>
<p>etc.  Now maybe our whole commit listing can include files and directories for
the root directory of our project, something like:</p>
<div class="highlight-python"><div class="highlight"><pre>9e398c7cf8d56e960aa7769839cc0c38b8e12f11 file chapter1.txt
65735b3705284cdf4a66c2e4812ca13cbaa7cd5d file chapter2.txt
3c2e09cc43568f13444c075c84b047957f7995a5 file chapter1_discussion.txt
f31bfa1225f9e0eb6741a0ab1122f8cd2cbedc04 file contents.txt
be242dba385bc0689be16454e959f4b64c87abce tree images
</pre></div>
</div>
<p>Oh - but wait - that&#8217;s just a tree listing too, let&#8217;s make a hash for that, and
put it into the <tt class="docutils literal"><span class="pre">.ahole/objects</span></tt> directory:</p>
<div class="highlight-python"><div class="highlight"><pre>│   ├── objects
│   │   ├── e52dc9dbe358c549df65307652ff2709322812b3 (root listing)
│   │   ├── be242dba385bc0689be16454e959f4b64c87abce (images_listing)
│   │   ├── 82e6792faa893070dcd6fe3e614b6f147be1a0a9 (adam_with_apple.jpg)
</pre></div>
</div>
<p>Right - so now our whole commit boils down to our <tt class="docutils literal"><span class="pre">info.txt</span></tt> file, and the
hash for the root tree (the one starting &#8216;e52dc&#8217; above). We can get rid of the
old <tt class="docutils literal"><span class="pre">files</span></tt> subdirectory in the commit, and add the hash for the root tree
instead - something like:</p>
<div class="highlight-python"><div class="highlight"><pre>committer = Eve
message = Adding funny pictures
date = year0-jan-06
root_tree = e52dc9dbe358c549df65307652ff2709322812b3
parent = 0a01a0
</pre></div>
</div>
<p>Now we can solve the annoying problem of finding an unique commit id for each
commit.   We just make a hash for the <tt class="docutils literal"><span class="pre">info.txt</span></tt> file, and put that into the
<tt class="docutils literal"><span class="pre">.ahole/objects</span></tt> directory too, as a <em>commit</em> file:</p>
<div class="highlight-python"><div class="highlight"><pre>│   ├── objects
│   │   ├── 7e0cda8c145b300b519ed28998a31f801b6d626f (latest commit)
│   │   ├── e52dc9dbe358c549df65307652ff2709322812b3 (root listing)
│   │   ├── be242dba385bc0689be16454e959f4b64c87abce (images_listing)
</pre></div>
</div>
<p>The unique id for the commit is the hash for its contents. In this case the
commit id is &#8216;7e0cda8c145b300b519ed28998a31f801b6d626f&#8217;.  Don&#8217;t forget that the
hash is more or less unique to the contents, so this commit will have an id that
is unique to the combination of the committer, message, date, root tree hash and
commit parent.  The root tree hash is unique to the contents of the root tree
listing, and the root tree listing contains file hashes, which are in turn
unique to the file contents, so the root tree hash will be unique to the file
contents of the commit.  Thus, the commit id is unique to all the things that go
into the commit, including the contents.  It&#8217;s clever isn&#8217;t it?</p>
<p>We can now have three types of files in the <tt class="docutils literal"><span class="pre">.ahole/objects</span></tt> directory -
files, trees, and commits.</p>
<p>OK - so things are now a little more complicated than our previous setup with
file copies, but lots of things have just got much easier.   For example, we can
now get rid of the <tt class="docutils literal"><span class="pre">staging_area</span></tt> directory.  The staging area can just be a
single file containing the root tree listing of the snapshot.  Let&#8217;s call that
file <tt class="docutils literal"><span class="pre">.ahole/index</span></tt>.  Now Eve has done her new commit, that file can just be
the root directory listing of the previous commit (the commit we have just
done):</p>
<div class="highlight-python"><div class="highlight"><pre>9e398c7cf8d56e960aa7769839cc0c38b8e12f11 file chapter1.txt
65735b3705284cdf4a66c2e4812ca13cbaa7cd5d file chapter2.txt
3c2e09cc43568f13444c075c84b047957f7995a5 file chapter1_discussion.txt
f31bfa1225f9e0eb6741a0ab1122f8cd2cbedc04 file contents.txt
be242dba385bc0689be16454e959f4b64c87abce tree images
</pre></div>
</div>
<p>When Eve makes an edit to <tt class="docutils literal"><span class="pre">chapter1.txt</span></tt>, instead of copying the file to the
<tt class="docutils literal"><span class="pre">staging_area</span></tt> directory, she makes a hash for the new <tt class="docutils literal"><span class="pre">chapter1.txt</span></tt>
contents, she stores the new <tt class="docutils literal"><span class="pre">chapter1.txt</span></tt> contents in the <tt class="docutils literal"><span class="pre">.ahole/objects</span></tt>
directory using the hash as a filename, and then she edits the <tt class="docutils literal"><span class="pre">.ahole/index</span></tt>
file to point to her new chapter 1 contents instead of the old.  She might
automate this with a small command like <tt class="docutils literal"><span class="pre">ahole_stage</span></tt> <a class="footnote-reference" href="#need-hashlib" id="id3">[3]</a></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">ahole_stage</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="c"># Get the hash for the file contents</span>
    <span class="n">file_contents</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">file_hash</span> <span class="o">=</span> <span class="n">sha1_hash</span><span class="p">(</span><span class="n">file_contents</span><span class="p">)</span>
    <span class="c"># (assuming that the new file is going in the root directory)</span>
    <span class="n">new_root_entry</span> <span class="o">=</span> <span class="n">file_hash</span> <span class="o">+</span> <span class="s">&#39; file &#39;</span> <span class="o">+</span> <span class="n">fname</span>
    <span class="n">root_listing</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="s">&#39;.ahole/index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">new_root_entry</span> <span class="ow">in</span> <span class="n">root_listing</span><span class="p">:</span>
        <span class="c"># This exact file contents and filename already present</span>
        <span class="k">return</span>
    <span class="c"># Make an entry for these file contents in the objects database</span>
    <span class="n">database_fname</span> <span class="o">=</span> <span class="s">&#39;.ahole/objects/&#39;</span> <span class="o">+</span> <span class="n">file_hash</span>
    <span class="nb">file</span><span class="p">(</span><span class="n">database_fname</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_contents</span><span class="p">)</span>
    <span class="c"># Write index listing with new entry</span>
    <span class="n">root_listing</span> <span class="o">=</span> <span class="n">root_listing</span> <span class="o">+</span> <span class="n">new_root_entry</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="nb">file</span><span class="p">(</span><span class="s">&#39;.ahole/index&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">root_listing</span><span class="p">)</span>
</pre></div>
</div>
<p>Making a new commit involves taking the contents of <tt class="docutils literal"><span class="pre">.ahole/index</span></tt> and using
it to make a new commit file in <tt class="docutils literal"><span class="pre">.ahole/objects</span></tt>.  Using the structure of our
previous <tt class="docutils literal"><span class="pre">ahole_commit</span></tt> routine, that might look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">ahole_commit</span><span class="p">(</span><span class="n">committer</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="c"># *** this stuff is the same as before ***</span>
    <span class="c"># Get previous (parent) commit id from .ahole/HEAD</span>
    <span class="n">head_contents</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="s">&#39;.ahole/HEAD&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="c"># Check if this is a reference, de-reference if so</span>
    <span class="c"># Also, get file into which to write the new commit id</span>
    <span class="k">if</span> <span class="n">head_contents</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;ref: &#39;</span><span class="p">):</span>
        <span class="n">head_ref</span> <span class="o">=</span> <span class="n">head_contents</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;ref: &#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">head_ref_file</span> <span class="o">=</span> <span class="s">&#39;.ahole/&#39;</span> <span class="o">+</span> <span class="n">head_ref</span>
        <span class="n">head_id</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">head_ref_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">head_ref_file</span> <span class="o">=</span> <span class="s">&#39;.ahole/HEAD&#39;</span>
        <span class="n">head_id</span> <span class="o">=</span> <span class="n">head_contents</span>
    <span class="c"># *** the stuff below is different ***</span>
    <span class="c"># Make root tree entry in objects database from .ahole/index</span>
    <span class="n">index_contents</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="s">&#39;.ahole/index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">index_hash</span> <span class="o">=</span> <span class="n">sha1_hash</span><span class="p">(</span><span class="n">index_contents</span><span class="p">)</span>
    <span class="nb">file</span><span class="p">(</span><span class="s">&#39;.ahole/objects/&#39;</span> <span class="o">+</span> <span class="n">index_hash</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">index_contents</span><span class="p">)</span>
    <span class="c"># Make commit information with parent set to HEAD</span>
    <span class="n">info_str</span> <span class="o">=</span> <span class="s">&#39;committer = &#39;</span> <span class="o">+</span> <span class="n">committer</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s">&#39;message = &#39;</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s">&#39;date = &#39;</span> <span class="o">+</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s">&#39;root_tree = &#39;</span> <span class="o">+</span> <span class="n">index_hash</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s">&#39;parent = &#39;</span> <span class="o">+</span> <span class="n">head_id</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="c"># Write commit file into objects database, with hash</span>
    <span class="n">commit_hash</span> <span class="o">=</span> <span class="n">sha1_hash</span><span class="p">(</span><span class="n">info_str</span><span class="p">)</span>
    <span class="nb">file</span><span class="p">(</span><span class="s">&#39;.ahole/objects/&#39;</span> <span class="o">+</span> <span class="n">commit_hash</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">info_str</span><span class="p">)</span>
    <span class="c"># Set the current commit file to contain new id</span>
    <span class="nb">file</span><span class="p">(</span><span class="n">head_ref_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">commit_hash</span><span class="p">)</span>
</pre></div>
</div>
<p>How about doing a merge?  Remember that, in the bad old days, we had to compare
lots of files between the branches, and the common ancestor?  No more.  Now we
are using the hash file references, all we need to do, is look at the tree
listing.  If the tree listing has the same entry (filename and hash) that means
that the file is identical between the two trees, and we don&#8217;t have to load the
contents to check. That makes it very fast to do comparisons between trees that
haven&#8217;t changed much.</p>
<p>Eve was right of course.  Now, if we make a new commit, when one file is
changed, all we store is the contents of the file that has changed and a new
tree listing with the updated hash for the changed file.  That makes the storage
for lots and lots of similar trees very efficient.</p>
<p>Someone ought to write this up and give it to the world.  Wait, that&#8217;s just us.</p>
</div>
<div class="section" id="on-the-seventh-day-there-was-git">
<h2>On the seventh day - there was git<a class="headerlink" href="#on-the-seventh-day-there-was-git" title="Permalink to this headline">¶</a></h2>
<p>The seventh day is for resting.   You are all done now, and the hard stuff is
over.  In a state of deep inner peace, you can think about all that you&#8217;ve
discovered in <em>ahole</em>:</p>
<ul class="simple">
<li>A commit refers to a snapshot of the complete set of files for your project</li>
<li>The staging area (index) defines what will change between your upcoming commit
and the previous commit</li>
<li>A branch is just a pointer to a commit, that moves when you do another commit.</li>
<li>Version control is very easy to understand</li>
</ul>
<p>You remind yourself that life is very good, because you don&#8217;t have to use a
version control system called <em>ahole</em>, you can use a very similar system called
<a class="reference external" href="http://git-scm.com">git</a>.</p>
<p>If you use <a class="reference external" href="http://git-scm.com">git</a>, you&#8217;ll notice that you have lots of <em>ahole</em> friends.  You&#8217;ll
see git creates a <tt class="docutils literal"><span class="pre">.git</span></tt> subdirectory that contains the repository.  You&#8217;ll
recognize the <tt class="docutils literal"><span class="pre">.git/objects</span></tt> directory containing filenames with SHA1 hashes.
You&#8217;ll see that commits have SHA1 hashes.  You&#8217;ll recognize the <tt class="docutils literal"><span class="pre">.git/HEAD</span></tt>
file and <tt class="docutils literal"><span class="pre">.git/refs/heads</span></tt> and <tt class="docutils literal"><span class="pre">.git/refs/tags</span></tt> and
<tt class="docutils literal"><span class="pre">.git/refs/heads/master</span></tt>. There is a <tt class="docutils literal"><span class="pre">.git/index</span></tt> file, and it is the
staging area. <tt class="docutils literal"><span class="pre">.git/index</span></tt> is a little more complicated than <tt class="docutils literal"><span class="pre">.ahole/index</span></tt>
because it&#8217;s adapted to helping with difficult merges, but it&#8217;s the same idea.</p>
<p>You now live in the garden of Eden of version control.  Remember to stay away
from that apple tree.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="ahole-git" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><tt class="docutils literal"><span class="pre">ahole</span></tt> might seem a bit rude to you, but I was born in the UK, and,
where I come from, &#8216;ahole&#8217; is roughly as rude as &#8216;git&#8217;.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="commit-imports" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><p class="first">In case you are interested, for the commit and checkout
code to actually run, you would need some python definitions.  First some
standard python imports:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">mkdir</span><span class="p">,</span> <span class="n">listdir</span>
</pre></div>
</div>
<p>Then we need some simple custom commands for deleting our working tree, and
for copying files into the working tree:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">remove</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">isdir</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copyfile</span><span class="p">,</span> <span class="n">copytree</span><span class="p">,</span> <span class="n">rmtree</span>

<span class="k">def</span> <span class="nf">delete_tree</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="c"># Delete everything in path unless it&#39;s an &#39;.ahole&#39; directory</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">remove</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">isdir</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;.ahole&#39;</span><span class="p">:</span>
                <span class="n">rmtree</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">copy_tree</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">dst_path</span><span class="p">):</span>
    <span class="c"># Copy everything in src_path to dst_path</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">src_path</span><span class="p">):</span>
        <span class="n">src_name</span> <span class="o">=</span> <span class="n">src_path</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="n">dst_name</span> <span class="o">=</span> <span class="n">dst_path</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">src_name</span><span class="p">):</span>
            <span class="n">copyfile</span><span class="p">(</span><span class="n">src_name</span><span class="p">,</span> <span class="n">dst_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">isdir</span><span class="p">(</span><span class="n">src_name</span><span class="p">):</span>
            <span class="n">copytree</span><span class="p">(</span><span class="n">src_name</span><span class="p">,</span> <span class="n">dst_name</span><span class="p">)</span>
</pre></div>
</div>
<p class="last">We also need some definition of <tt class="docutils literal"><span class="pre">make_unique_id()</span></tt>.</p>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="need-hashlib" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><p class="first">Now you need to add:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">hashlib</span>

<span class="k">def</span> <span class="nf">sha1_hash</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1_hash</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
</pre></div>
</div>
<p class="last">.</p>
</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Git foundations</a><ul>
<li><a class="reference internal" href="#on-the-first-day-the-repository-and-the-working-tree">On the first day - the repository and the working tree</a></li>
<li><a class="reference internal" href="#on-the-second-day-staging-and-commits">On the second day - staging and commits</a></li>
<li><a class="reference internal" href="#on-the-third-day-history">On the third day - history</a></li>
<li><a class="reference internal" href="#on-the-fourth-day-references">On the fourth day - references</a></li>
<li><a class="reference internal" href="#on-the-fifth-day-branches-merges-and-remotes">On the fifth day - branches, merges and remotes</a></li>
<li><a class="reference internal" href="#on-the-sixth-day-saving-time-and-space-with-objects">On the sixth day - saving time and space with objects</a></li>
<li><a class="reference internal" href="#on-the-seventh-day-there-was-git">On the seventh day - there was git</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Welcome to Pydagogue</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="decorating_for_dummies.html"
                        title="next chapter">What is a decorator?</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/foundation.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="decorating_for_dummies.html" title="What is a decorator?"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to Pydagogue"
             >previous</a> |</li>
        <li><a href="index.html">pydagogue 0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009, 2010 - Matthew Brett.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>