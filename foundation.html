
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Git foundations &#8212; pydagogue 0.2 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/traditional.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Rebase without tears" href="rebase_without_tears.html" />
    <link rel="prev" title="Reading git objects" href="reading_git_objects.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="rebase_without_tears.html" title="Rebase without tears"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="reading_git_objects.html" title="Reading git objects"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pydagogue 0.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="git.html" accesskey="U">Notes and tutorials on git</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Git foundations</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="git-foundations">
<span id="git-foundation"></span><h1>Git foundations<a class="headerlink" href="#git-foundations" title="Permalink to this headline">¶</a></h1>
<p>“Foundations” is a little joke on a religious theme; our page borrows heavily
from the <a class="reference external" href="http://practical-neuroimaging.github.io/git_parable.html">git parable</a> - so - why not a foundation myth?</p>
<div class="section" id="on-the-first-day-the-repository-and-the-working-tree">
<h2>On the first day - the repository and the working tree<a class="headerlink" href="#on-the-first-day-the-repository-and-the-working-tree" title="Permalink to this headline">¶</a></h2>
<p>I’m young and the world is fresh and I have lots of time.</p>
<p>I have so much time, that I decide that I want to write a book.  The project I
am working on is a modest history and explanation of everything, with
provisional title “The Book”.  It has a table of contents <code class="docutils literal notranslate"><span class="pre">contents.txt</span></code> and a
single book chapter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>As I start to write, I begin to think I should keep track of my changes.  I need
some sort of version control system.  How hard can it be?</p>
<p>I start with some names.  I’m going to call this set of files that I’m working
on, the <em>working tree</em>. Because I currently lack any shame about body issues, I
will call my new versioning system <code class="docutils literal notranslate"><span class="pre">ahole</span></code> <a class="footnote-reference brackets" href="#ahole-git" id="id1">1</a> .</p>
<p>I decide that I need to store the state of The Book at the end of each
day.  To do this, I make a new directory in my working tree, called <code class="docutils literal notranslate"><span class="pre">.ahole</span></code>.
This directory will store The Book as it evolves into a world-wide best-seller.
I will use the name <em>repository</em> for the contents of <code class="docutils literal notranslate"><span class="pre">.ahole</span></code>.</p>
<p>At the end of the day, I make a copy of all the files in the working tree, and
save it in my new <code class="docutils literal notranslate"><span class="pre">.ahole</span></code> repository.  In fact, what I will do is, make a new
subdirectory in <code class="docutils literal notranslate"><span class="pre">.ahole</span></code> named for today’s date, then store a copy of the book
files in there.  On unix, that might look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">year0</span><span class="o">-</span><span class="n">jan</span><span class="o">-</span><span class="mi">01</span>
<span class="n">mkdir</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">year0</span><span class="o">-</span><span class="n">jan</span><span class="o">-</span><span class="mi">01</span><span class="o">/</span><span class="n">files</span>
<span class="n">cp</span> <span class="o">*</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">year0</span><span class="o">-</span><span class="n">jan</span><span class="o">-</span><span class="mi">01</span><span class="o">/</span><span class="n">files</span>
</pre></div>
</div>
<p>So I’ve still got the contents of The Book in the working tree, but now, in the
repository, I have a copy of the files that is a snapshot of The Book as of
today:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── .ahole
│   └── year0-jan-01
│       └── files
│           ├── chapter1.txt
│           └── contents.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
</div>
<div class="section" id="on-the-second-day-staging-and-commits">
<h2>On the second day - staging and commits<a class="headerlink" href="#on-the-second-day-staging-and-commits" title="Permalink to this headline">¶</a></h2>
<p>Today I do some more work on the book.   I start work on chapter 2, and, while
I’m thinking about things, I find that I am also writing some notes to myself
about this character “Eve” that I have seen wandering around.  I save those
notes in a file called <code class="docutils literal notranslate"><span class="pre">something_about_eve.txt</span></code>.  When I get to the end of
the day, I get ready to store my work.  At the moment, my directory looks like
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── .ahole
│   └── year0-jan-01
│       └── files
│           ├── chapter1.txt
│           └── contents.txt
├── something_about_eve.txt
├── chapter2.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>For some reason I can’t put my finger on, I don’t want to put
<code class="docutils literal notranslate"><span class="pre">something_about_eve.txt</span></code> into the repository at the moment.  In fact, in
general, I want to choose which changes I back up into the repository, and which
changes I leave for another day.  In the end I come up with an idea.  I’ll make
a directory in <code class="docutils literal notranslate"><span class="pre">.ahole</span></code> called <code class="docutils literal notranslate"><span class="pre">staging_area</span></code>.  When I start work at the
beginning of the day, I copy the previous backed-up version of my files from the
repository, into <code class="docutils literal notranslate"><span class="pre">staging_area</span></code>. These files are now ready for storing in the
next snapshot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">year0</span><span class="o">-</span><span class="n">jan</span><span class="o">-</span><span class="mi">01</span><span class="o">/*</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">staging_area</span>
</pre></div>
</div>
<p>I now have:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>├── .ahole
│   ├─── staging_area
│   │    ├── chapter1.txt
│   │    └── contents.txt
│   └── year0-jan-01
│       └── files
│           ├── chapter1.txt
│           └── contents.txt
├── something_about_eve.txt
├── chapter2.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>As I work, I decide what I’m going to put into tonight’s snapshot.  For example,
maybe I changed <code class="docutils literal notranslate"><span class="pre">chapter1.txt</span></code> and I think it’s ready to back up. I copy my
modified version of <code class="docutils literal notranslate"><span class="pre">chapter1.txt</span></code> from the working tree to <code class="docutils literal notranslate"><span class="pre">staging_area</span></code>.
I’ll call that <em>stage</em>-ing the file.  I’ll also ‘stage’ the new <code class="docutils literal notranslate"><span class="pre">chapter2.txt</span></code>
file (copy it to the staging area).  I’m not going to stage
<code class="docutils literal notranslate"><span class="pre">something_about_eve.txt</span></code> at the moment.</p>
<p>Now I’ve done that, all the stuff I want to store in the backup is ready.  I
just need to put it into its own backup snapshot directory.   To do that, I just
do something like (Unix again):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">year0</span><span class="o">-</span><span class="n">jan</span><span class="o">-</span><span class="mi">02</span>
<span class="n">mkdir</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">year0</span><span class="o">-</span><span class="n">jan</span><span class="o">-</span><span class="mi">02</span><span class="o">/</span><span class="n">files</span>
<span class="n">cp</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">staging_area</span><span class="o">/*</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">year0</span><span class="o">-</span><span class="n">jan</span><span class="o">-</span><span class="mi">02</span><span class="o">/</span><span class="n">files</span>
</pre></div>
</div>
<p>I end up with a directory that looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── .ahole
│   ├── year0-jan-02
│   │   └── files
│   │       ├── chapter2.txt
│   │       ├── chapter1.txt
│   │       └── contents.txt
│   ├─── staging_area
│   │    ├── chapter2.txt
│   │    ├── chapter1.txt
│   │    └── contents.txt
│   └── year0-jan-01
│       └── files
│           ├── chapter1.txt
│           └── contents.txt
├── something_about_eve.txt
├── chapter2.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>I decide that I’ll use the name <em>commit</em> for each of the daily snapshot
directories (<code class="docutils literal notranslate"><span class="pre">year0-jan-01</span></code> and <code class="docutils literal notranslate"><span class="pre">year0-jan-02</span></code>).  The action of adding files
to the staging area, I will call <em>staging</em> files for the commit.  I will use
the term <em>committing</em> for the action of making the snapshot directory, and
copying the files from the staging area to the snapshot directory.</p>
</div>
<div class="section" id="on-the-third-day-history">
<h2>On the third day - history<a class="headerlink" href="#on-the-third-day-history" title="Permalink to this headline">¶</a></h2>
<p>As a result of certain events yesterday evening, I have a new friend, Eve.  She
wants to help out.  Of course Eve has her own computer, and I send her my
<code class="docutils literal notranslate"><span class="pre">.ahole</span></code> directory.  I thank myself for my wisdom in not adding
<code class="docutils literal notranslate"><span class="pre">something_about_eve.txt</span></code> to the repository.</p>
<p>Eve checks out our book (reconstructs my working tree) with something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">year0</span><span class="o">-</span><span class="n">jan</span><span class="o">-</span><span class="mi">02</span><span class="o">/</span><span class="n">files</span><span class="o">/*</span> <span class="o">.</span>
</pre></div>
</div>
<p>Now she’s got the book files as I committed them last night.  She also copies
the last commit files into the staging area, as I did:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>├── .ahole
│   ├─── staging_area
│   │    ├── chapter2.txt
│   │    ├── chapter1.txt
│   │    └── contents.txt
</pre></div>
</div>
<p>She works hard on a new file <code class="docutils literal notranslate"><span class="pre">chapter1_discussion.txt</span></code>. It’s good to see she’s
enjoying the work.  As the afternoon turns to evening, she gets ready to save
her work, so she copies <code class="docutils literal notranslate"><span class="pre">chapter1_discussion.txt</span></code> to <code class="docutils literal notranslate"><span class="pre">.ahole/staging_area</span></code>.
Now she is ready to do a commit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">year0</span><span class="o">-</span><span class="n">jan</span><span class="o">-</span><span class="mi">03</span>
<span class="n">mkdir</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">year0</span><span class="o">-</span><span class="n">jan</span><span class="o">-</span><span class="mi">03</span><span class="o">/</span><span class="n">files</span>
<span class="n">cp</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">staging_area</span><span class="o">/*</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">year0</span><span class="o">-</span><span class="n">jan</span><span class="o">-</span><span class="mi">03</span><span class="o">/</span><span class="n">files</span>
</pre></div>
</div>
<p>That is what Eve was going to do, but Eve is smart, and she immediately realizes
that there is a problem.  After she has done her commit, both of us will likely
have a commit directory <code class="docutils literal notranslate"><span class="pre">.ahole/year0-jan-03</span></code> - but they will have different
contents.   If she later wants to share work with me, that could get confusing.</p>
<p>The two of us are a little tired after all our work, and we meet for a beer.  We
talk about it for a while.  At first we think we can just add the time to the
date, because that’s likely to be unique for each of us.  Then we realize that
that’s going to get messy too, because, if Eve does a commit on her computer,
then I do a commit on mine, and she does another one on hers, the times will say
that these are all in one sequence, but in fact there are two sequences, mine,
and Eves.  We need some other way to keep track of the sequence of commits, that
will work even if two of us are working independently.</p>
<p>In the end we decide that we are going to give the commits some unique
identifier string instead of the date.  We might have a problem in making sure
that the unique identifier string is actually unique, but let’s assume we can
solve that somehow.  We’ll store the contents of the working tree in the same
way as we have done up till now, in the <code class="docutils literal notranslate"><span class="pre">files</span></code> subdirectory, but we’ll add a
new file to each commit, called <code class="docutils literal notranslate"><span class="pre">info.txt</span></code>, that will tell us who did the
commit, and when, and, most importantly, what the previous commit was.  We’ll
call the previous commit the <em>parent</em>.</p>
<p>Eve was right to predict that I had made my own commit today.  I’ve been happily
working on chapter 3.  So, before our conversation, my directory looked like
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── .ahole
│   ├── year0-jan-03
│   │   └── files
│   │       ├── chapter3.txt
│   │       ├── chapter2.txt
│   │       ├── chapter1.txt
│   │       └── contents.txt
│   ├─── staging_area
│   │    ├── chapter3.txt
│   │    ├── chapter2.txt
│   │    ├── chapter1.txt
│   │    └── contents.txt
│   ├── year0-jan-02
│   │   └── files
│   │       ├── chapter2.txt
│   │       ├── chapter1.txt
│   │       └── contents.txt
│   └── year0-jan-01
│       └── files
│           ├── chapter1.txt
│           └── contents.txt
├── something_about_eve.txt
├── chapter3.txt
├── chapter2.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>but now we’ve worked out the new way, it looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── .ahole
│   ├── 5d89f8
│   │   ├── info.txt
│   │   └── files
│   │       ├── chapter3.txt
│   │       ├── chapter2.txt
│   │       ├── chapter1.txt
│   │       └── contents.txt
│   ├─── staging_area
│   │    ├── chapter3.txt
│   │    ├── chapter2.txt
│   │    ├── chapter1.txt
│   │    └── contents.txt
│   ├── 7ef41f
│   │   ├── info.txt
│   │   └── files
│   │       ├── chapter2.txt
│   │       ├── chapter1.txt
│   │       └── contents.txt
│   └── 6438a4
│       ├── info.txt
│       └── files
│           ├── chapter1.txt
│           └── contents.txt
├── something_about_eve.txt
├── chapter3.txt
├── chapter2.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>and <code class="docutils literal notranslate"><span class="pre">.ahole/5d89f8/info.txt</span></code> looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">committer</span> <span class="o">=</span> <span class="n">Adam</span>
<span class="n">message</span> <span class="o">=</span> <span class="n">Third</span> <span class="n">day</span>
<span class="n">date</span> <span class="o">=</span> <span class="n">year0</span><span class="o">-</span><span class="n">jan</span><span class="o">-</span><span class="mi">03</span>
<span class="n">parent</span> <span class="o">=</span> <span class="mi">7</span><span class="n">ef41f</span>
</pre></div>
</div>
<p>Meanwhile, Eve’s directory looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── .ahole
│   ├── 0a01a0
│   │   ├── info.txt
│   │   └── files
│   │       ├── chapter1_discussion.txt
│   │       ├── chapter2.txt
│   │       ├── chapter1.txt
│   │       └── contents.txt
│   ├─── staging_area
│   │    ├── chapter1_discussion.txt
│   │    ├── chapter2.txt
│   │    ├── chapter1.txt
│   │    └── contents.txt
│   ├── 7ef41f
│   │   ├── info.txt
│   │   └── files
│   │       ├── chapter2.txt
│   │       ├── chapter1.txt
│   │       └── contents.txt
│   └── 6438a4
│       ├── info.txt
│       └── files
│           ├── chapter1.txt
│           └── contents.txt
├── chapter1_discussion.txt
├── chapter2.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>and Eve’s <code class="docutils literal notranslate"><span class="pre">.ahole/0a01a0/info.txt</span></code> looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">committer</span> <span class="o">=</span> <span class="n">Eve</span>
<span class="n">message</span> <span class="o">=</span> <span class="n">Eve</span> <span class="n">day</span> <span class="mi">3</span>
<span class="n">date</span> <span class="o">=</span> <span class="n">year0</span><span class="o">-</span><span class="n">jan</span><span class="o">-</span><span class="mi">03</span>
<span class="n">parent</span> <span class="o">=</span> <span class="mi">7</span><span class="n">ef41f</span>
</pre></div>
</div>
<p>After a little thought, Eve and I realize that, when we make our new commit, we
are going to have to know what the current commit is, so we can use that as the
parent.  When we make a new commit, we store the commit identifier in a file.
We’ll call this file <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code>, so, after my last commit above, the file
<code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code> will have the contents <code class="docutils literal notranslate"><span class="pre">5d89f8</span></code>. We use the contents of
<code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code> to identify the last (current) commit.  And of course, when we
make a new commit, we can get the parent of the new commit, from the current
commit in <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code>.</p>
<p>So now, we have a new procedure for our commit.  In outline it looks like this
(now in <a class="reference external" href="http://www.python.org">python</a> syntax) <a class="footnote-reference brackets" href="#commit-imports" id="id2">2</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ahole_commit</span><span class="p">(</span><span class="n">committer</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="c1"># Make a unique identifier for this commit somehow</span>
    <span class="n">new_id</span> <span class="o">=</span> <span class="n">make_unique_id</span><span class="p">()</span>
    <span class="c1"># Make a new directory in ahole with the new unique name</span>
    <span class="n">commit_dir</span> <span class="o">=</span> <span class="s1">&#39;.ahole/&#39;</span> <span class="o">+</span> <span class="n">new_id</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">commit_dir</span><span class="p">)</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s1">&#39;/files&#39;</span><span class="p">)</span>
    <span class="c1"># Copy the files from the staging area to the new snapshot directory</span>
    <span class="n">copy_tree</span><span class="p">(</span><span class="s1">&#39;.ahole/staging_area&#39;</span><span class="p">,</span> <span class="n">commit_dir</span> <span class="o">+</span> <span class="s1">&#39;/files&#39;</span><span class="p">)</span>
    <span class="c1"># Get previous (parent) commit id from .ahole/HEAD</span>
    <span class="n">head_id</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="s1">&#39;.ahole/HEAD&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="c1"># Make info with parent set to HEAD</span>
    <span class="n">info_str</span> <span class="o">=</span> <span class="s1">&#39;committer = &#39;</span> <span class="o">+</span> <span class="n">committer</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s1">&#39;message = &#39;</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s1">&#39;date = &#39;</span> <span class="o">+</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s1">&#39;parent = &#39;</span> <span class="o">+</span> <span class="n">head_id</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="c1"># Write info to info.txt file</span>
    <span class="n">info_file</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s1">&#39;/info.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">info_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">info_str</span><span class="p">)</span>
    <span class="n">info_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Set .ahole/HEAD to contain new commit id</span>
    <span class="n">file</span><span class="p">(</span><span class="s1">&#39;.ahole/HEAD&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_id</span><span class="p">)</span>
</pre></div>
</div>
<p>When we want to go back to an earlier state of the book, we can do a
<em>checkout</em>, with something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ahole_checkout</span><span class="p">(</span><span class="n">commit_id</span><span class="p">):</span>
    <span class="n">commit_dir</span> <span class="o">=</span> <span class="s1">&#39;.ahole/&#39;</span> <span class="o">+</span> <span class="n">commit_id</span>
    <span class="c1"># copy .ahole/$commit_id/files into working tree</span>
    <span class="n">delete_tree</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">copy_tree</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s1">&#39;/files&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="c1"># make .ahole/HEAD contain commit_id</span>
    <span class="n">file</span><span class="p">(</span><span class="s1">&#39;.ahole/HEAD&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">commit_id</span><span class="p">)</span>
    <span class="c1"># copy commit snapshot into staging area</span>
    <span class="n">delete_tree</span><span class="p">(</span><span class="s1">&#39;.ahole/staging_area&#39;</span><span class="p">)</span>
    <span class="n">copy_tree</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s1">&#39;/files&#39;</span><span class="p">,</span> <span class="s1">&#39;.ahole/staging_area&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>So, when we run <code class="docutils literal notranslate"><span class="pre">ahole_checkout('7ef41f`)</span></code> we will get the copy of the working
tree corresponging to <code class="docutils literal notranslate"><span class="pre">7ef41f</span></code>, and <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code> will just contain the
string <code class="docutils literal notranslate"><span class="pre">7ef41f</span></code>.</p>
<p>In our excitement, we immediately realize that it’s really easy to see the
history of the book now.  We can easily fetch out <code class="docutils literal notranslate"><span class="pre">info.txt</span></code> from the current
commit, print it, then find its parent, and fetch <code class="docutils literal notranslate"><span class="pre">info.txt</span></code> from the parent,
print it, and so on.</p>
<p>Now we are tired, but happy, and we rest.</p>
</div>
<div class="section" id="on-the-fourth-day-references">
<h2>On the fourth day - references<a class="headerlink" href="#on-the-fourth-day-references" title="Permalink to this headline">¶</a></h2>
<p>We wake with a strange excitement.  The idea, of keeping a reference to the
current commit in <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code>, seems that it could be more general.  I
talk to Eve over breakfast (she stayed in her own place of course, but she came
over for work).  Together we work out the concept of <em>references</em>. A reference
is:</p>
<dl class="simple">
<dt>Reference</dt><dd><p>Something that points to a commit</p>
</dd>
</dl>
<p>So, <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code> is a reference - to the current commit.  But what if I decide
that I want to give out some preliminary version of our book.  Let’s say I want
to release the book stored in <code class="docutils literal notranslate"><span class="pre">.ahole/7ef41f/files</span></code> as ‘release-0.1’.   I’m
going to send this out to all my friends (to be honest, I don’t have many
friends just yet, but still).  I want to be able to remember what version of the
book I sent out.  I can make a <em>reference</em> to this commit.  I’ll call this a
<em>tag</em>.   I make a new directory in <code class="docutils literal notranslate"><span class="pre">.ahole</span></code> called <code class="docutils literal notranslate"><span class="pre">refs</span></code>, and another
directory in <code class="docutils literal notranslate"><span class="pre">refs</span></code>, called <code class="docutils literal notranslate"><span class="pre">tags</span></code>, and then, in
<code class="docutils literal notranslate"><span class="pre">.ahole/refs/tags/release-0.1</span></code> I just put <code class="docutils literal notranslate"><span class="pre">7ef41f</span></code> - a reference to the
release commit.   That way, if I ever need to go back to the version of the book
I released, I just have to read the <code class="docutils literal notranslate"><span class="pre">release-0.1</span></code> file to find the commit, and
then checkout that commit.</p>
<p>Wait, but, there’s a problem.  If I checkout the commit in <code class="docutils literal notranslate"><span class="pre">release-0.1</span></code>, I
will overwrite <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code>, and I will lose track of what commit I was
working on before.</p>
<p>Let’s store that in another reference.  Let’s use the name ‘master’ for my main
line of development.  I store where this is, by making a new file
<code class="docutils literal notranslate"><span class="pre">.ahole/refs/heads/master</span></code> that is a reference to the last commit.  It just
contains the text ‘5d89f8’.  So that I know that I am working on ‘master’, I
make <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code> have the text <code class="docutils literal notranslate"><span class="pre">ref:</span> <span class="pre">refs/heads/master</span></code>.  Now, when I make
a new commit, I first check <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code>; if I see <code class="docutils literal notranslate"><span class="pre">ref:</span>
<span class="pre">refs/heads/master</span></code>, then first, I get the commit id in
<code class="docutils literal notranslate"><span class="pre">.ahole/refs/heads/master</span></code> - and I use that as the parent id for the commit.
When I’ve saved the new commit, I set <code class="docutils literal notranslate"><span class="pre">.ahole/refs/heads/master</span></code> to have the
new commit id.  So, I need to modify my commit procedure slightly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ahole_commit</span><span class="p">(</span><span class="n">committer</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="c1"># *** this stuff down to the next *** line is new</span>
    <span class="c1"># Get previous (parent) commit id from .ahole/HEAD</span>
    <span class="n">head_contents</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="s1">&#39;.ahole/HEAD&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="c1"># Check if this is a reference, de-reference if so</span>
    <span class="c1"># Also, get file into which to write the new commit id</span>
    <span class="k">if</span> <span class="n">head_contents</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ref: &#39;</span><span class="p">):</span>
        <span class="n">head_ref</span> <span class="o">=</span> <span class="n">head_contents</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ref: &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">head_ref_file</span> <span class="o">=</span> <span class="s1">&#39;.ahole/&#39;</span> <span class="o">+</span> <span class="n">head_ref</span>
        <span class="n">head_id</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">head_ref_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">head_ref_file</span> <span class="o">=</span> <span class="s1">&#39;.ahole/HEAD&#39;</span>
        <span class="n">head_id</span> <span class="o">=</span> <span class="n">head_contents</span>
    <span class="c1"># *** the stuff below you&#39;ve seen before (until *** again)</span>
    <span class="c1"># Make a unique identifier for this commit somehow</span>
    <span class="n">new_id</span> <span class="o">=</span> <span class="n">make_unique_id</span><span class="p">()</span>
    <span class="c1"># Make a new directory in ahole with the new unique name</span>
    <span class="n">commit_dir</span> <span class="o">=</span> <span class="s1">&#39;.ahole/&#39;</span> <span class="o">+</span> <span class="n">new_id</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">commit_dir</span><span class="p">)</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s1">&#39;/files&#39;</span><span class="p">)</span>
    <span class="c1"># Copy the files from the staging area to the new snapshot directory</span>
    <span class="n">copy_tree</span><span class="p">(</span><span class="s1">&#39;.ahole/staging_area&#39;</span><span class="p">,</span> <span class="n">commit_dir</span> <span class="o">+</span> <span class="s1">&#39;/files&#39;</span><span class="p">)</span>
    <span class="c1"># Make info.txt with parent set to HEAD</span>
    <span class="n">info_str</span> <span class="o">=</span> <span class="s1">&#39;committer = &#39;</span> <span class="o">+</span> <span class="n">committer</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s1">&#39;message = &#39;</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s1">&#39;date = &#39;</span> <span class="o">+</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s1">&#39;parent = &#39;</span> <span class="o">+</span> <span class="n">head_id</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="c1"># Write info to info.txt file</span>
    <span class="n">info_file</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s1">&#39;/info.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">info_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">info_str</span><span class="p">)</span>
    <span class="n">info_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Set the file that points to the current commit, to point to our commit</span>
    <span class="c1"># *** a little new, in that we might be writing to .ahole/HEAD, or</span>
    <span class="c1"># something like .ahole/refs/heads/master, depending on what .ahole/HEAD</span>
    <span class="c1"># contained at the top of this routine</span>
    <span class="n">file</span><span class="p">(</span><span class="n">head_ref_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_id</span><span class="p">)</span>
</pre></div>
</div>
<p>So, let’s say that I’m currently on commit ‘5d89f8’.  <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code> contains
<code class="docutils literal notranslate"><span class="pre">ref:</span> <span class="pre">refs/heads/master</span></code>.  <code class="docutils literal notranslate"><span class="pre">.ahole/refs/heads/master</span></code> contains <code class="docutils literal notranslate"><span class="pre">5d89f8</span></code>.
I run my commit procedure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ahole_commit</span><span class="p">(</span><span class="s1">&#39;Adam&#39;</span><span class="p">,</span> <span class="s1">&#39;Night follows day&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The commit procedure has made a new commit ‘dfbeda’; <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code> continues
to have text <code class="docutils literal notranslate"><span class="pre">ref:</span> <span class="pre">refs/heads/master</span></code>, but now <code class="docutils literal notranslate"><span class="pre">.ahole/refs/heads/master</span></code>
contains <code class="docutils literal notranslate"><span class="pre">dfbeda</span></code>.  In this way, we keep track of which commit we are on, by
constantly updating ‘master’.</p>
<p>Ok - now let’s return to me checking out the released version of the book.  I
first get the contents of <code class="docutils literal notranslate"><span class="pre">.ahole/refs/tags/release-0.1</span></code> - it’s ‘5d89f8’.
Then I checkout the working tree for that version, using my nice
<code class="docutils literal notranslate"><span class="pre">ahole_checkout</span></code> procedure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ahole_checkout</span><span class="p">(</span><span class="s1">&#39;5d89f8&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The checkout procedure will make <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code> contain the text <code class="docutils literal notranslate"><span class="pre">5d89f8</span></code>.</p>
<p>Now I want to go back to working on my current version of the book.  That’s the
set of files pointed to by <code class="docutils literal notranslate"><span class="pre">.ahole/refs/heads/master</span></code>.  I can
check the contents of <code class="docutils literal notranslate"><span class="pre">.ahole/refs/heads/master</span></code> - it is <code class="docutils literal notranslate"><span class="pre">dfbeda</span></code>.  Then I
get the current version with the normal checkout procedure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ahole_checkout</span><span class="p">(</span><span class="s1">&#39;dfbeda&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, I’ll have to set <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code> to be <code class="docutils literal notranslate"><span class="pre">ref:</span> <span class="pre">refs/heads/master</span></code>.  All
good.</p>
<p>Of course, I could automate this, by modifying my checkout procedure slightly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ahole_checkout</span><span class="p">(</span><span class="n">commit_reference</span><span class="p">):</span>
   <span class="c1"># If this is a reference, dereference</span>
   <span class="k">if</span> <span class="n">commit_reference</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.ahole/refs/heads&#39;</span><span class="p">):</span>
       <span class="c1"># it&#39;s a head reference, maybe &#39;master&#39;</span>
       <span class="n">head_reference</span> <span class="o">=</span> <span class="kc">True</span>
       <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;.ahole/refs/heads/&#39;</span> <span class="o">+</span> <span class="n">commit_reference</span>
       <span class="n">commit_id</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
   <span class="k">elif</span> <span class="n">commit_reference</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.ahole/refs/tags&#39;</span><span class="p">):</span>
       <span class="c1"># it&#39;s a tag reference</span>
       <span class="n">head_reference</span> <span class="o">=</span> <span class="kc">False</span>
       <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;.ahole/refs/tags/&#39;</span> <span class="o">+</span> <span class="n">commit_reference</span>
       <span class="n">commit_id</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
   <span class="k">else</span><span class="p">:</span> <span class="c1"># Just a standard commit id</span>
       <span class="n">head_reference</span> <span class="o">=</span> <span class="kc">False</span>
       <span class="n">commit_id</span> <span class="o">=</span> <span class="n">commit_reference</span>
   <span class="n">commit_dir</span> <span class="o">=</span> <span class="s1">&#39;.ahole/&#39;</span> <span class="o">+</span> <span class="n">commit_id</span>
   <span class="c1"># copy .ahole/$commit_id/files into working tree</span>
   <span class="n">delete_tree</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
   <span class="n">copy_tree</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s1">&#39;/files&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
   <span class="c1"># make ahole/HEAD point to commit id</span>
   <span class="k">if</span> <span class="n">head_reference</span><span class="p">:</span>
       <span class="c1"># Point HEAD at head reference</span>
       <span class="n">file</span><span class="p">(</span><span class="s1">&#39;.ahole/HEAD&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ref: refs/heads/&#39;</span> <span class="o">+</span> <span class="n">commit_reference</span><span class="p">)</span>
       <span class="c1"># Write commit id into head reference file</span>
       <span class="n">file</span><span class="p">(</span><span class="s1">&#39;.ahole/refs/heads/&#39;</span> <span class="o">+</span> <span class="n">commit_reference</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">commit_id</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="n">file</span><span class="p">(</span><span class="s1">&#39;.ahole/HEAD&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">commit_id</span><span class="p">)</span>
   <span class="c1"># copy commit snapshot into staging area</span>
   <span class="n">delete_tree</span><span class="p">(</span><span class="s1">&#39;.ahole/staging_area&#39;</span><span class="p">)</span>
   <span class="n">copy_tree</span><span class="p">(</span><span class="n">commit_dir</span> <span class="o">+</span> <span class="s1">&#39;/files&#39;</span><span class="p">,</span> <span class="s1">&#39;.ahole/staging_area&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>What then, is the difference, between a <em>tag</em> - like our release - and the
moving target like ‘master’?  The ‘tag’ is a <em>static</em> reference - it does not
change when we do a commit and always points to the same commit.  ‘master’ is a
dynamic reference - in particular, it’s a <em>head</em> reference:</p>
<dl class="simple">
<dt>Head</dt><dd><p>A head is a reference that updates when we do a commit</p>
</dd>
</dl>
<p>My head is hurting a little, after Eve explains all this, but after a little
while and a nice apple pie, I’m feeling positive about <code class="docutils literal notranslate"><span class="pre">ahole</span></code>.</p>
</div>
<div class="section" id="on-the-fifth-day-branches-merges-and-remotes">
<h2>On the fifth day - branches, merges and remotes<a class="headerlink" href="#on-the-fifth-day-branches-merges-and-remotes" title="Permalink to this headline">¶</a></h2>
<p>Yesterday was a little exhausting, so today there was some time for reflection.</p>
<p>As Eve and I relax with the other animals, who are all getting on very well with
each other, we begin to realize that this <em>head</em> thing could be very useful.</p>
<p>For example, what if one of my very small number of friends tells me that
there’s a serious conceptual error in the version of the book that I released -
‘release-0.1’.  What if I want to go back and fix it - that is - do another
commit on top of the <em>released</em> book, instead of the version of the book that
I’m currently working on?  I can just make a new <em>head</em>.  I’ll do it like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">tags</span><span class="o">/</span><span class="n">release</span><span class="o">-</span><span class="mf">0.1</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">working</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="mf">0.1</span>
</pre></div>
</div>
<p>Then, I look at what commit <code class="docutils literal notranslate"><span class="pre">working-on-0.1</span></code> contains - of course it’s
<code class="docutils literal notranslate"><span class="pre">7ef41f</span></code>.  I get that state of the book with my new checkout procedure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ahole_checkout</span><span class="p">(</span><span class="s1">&#39;working-on-0.1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This changes <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code> to be <code class="docutils literal notranslate"><span class="pre">ref:</span> <span class="pre">refs/heads/working-on-0.1</span></code>.  Now,
when I do a commit with <code class="docutils literal notranslate"><span class="pre">ahole_commit</span></code>,  that will update the file
<code class="docutils literal notranslate"><span class="pre">.ahole/refs/heads/working-on-0.1</span></code> to have the new commit identifier.  Despite the
apple pie being a bit bitter last night, we’re feeling good.</p>
<p>As we think about this, we come to think of ‘master’ and ‘working-on-0.1’ as
<em>branches</em> - because they can each be thought of as identifying a tree or graph
of commits, which can grow.  All I need, to make a new branch, is make a
new head reference to a commit.  For example, if I want to make new branch
starting at the current position of ‘master’, all I need is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">tags</span><span class="o">/</span><span class="n">master</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">my</span><span class="o">-</span><span class="n">new</span><span class="o">-</span><span class="n">branch</span>
</pre></div>
</div>
<p>If I want to work on this branch, I need to check it out, with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ahole_checkout</span><span class="p">(</span><span class="s1">&#39;my-new-branch&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>That will get the commit identifier in <code class="docutils literal notranslate"><span class="pre">.ahole/refs/heads/my-new-branch</span></code>, unpack
the commit tree into the working tree, and set <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code> to contain the
text <code class="docutils literal notranslate"><span class="pre">ref:</span> <span class="pre">refs/heads/my-new-branch</span></code></p>
<p>I’ve got my branches, but Eve will have her own branches, and this will help us
know where each of us is working.</p>
<p>That’s good, because Eve is now asking me if I can have a look at her changes,
and whether I’ll include them in my version of the book.  Unwisely I end up
suggesting that women don’t contribute to books, and ask her why her hair isn’t
covered with an as-yet not-invented headscarf.  In the end we patch it up, and I
agree to go back and try and put in her changes.</p>
<p>Luckily, despite the lack of basics like clothing, there is an excellent local
network, so I can see the contents of her version of the book at
<code class="docutils literal notranslate"><span class="pre">/eves_computer/our_book/.ahole</span></code>.  She wants me to look at her ‘master’
branch.  Just because the network might fail, I need to fetch what I need from
her computer to mine.  So, to keep track of things, I’ll make a new directory,
called <code class="docutils literal notranslate"><span class="pre">.ahole/refs/remotes/eve</span></code>, and I’ll copy all her <em>heads</em> - in this case
just <code class="docutils literal notranslate"><span class="pre">master</span></code> - to that directory.   So now, I’ve got
<code class="docutils literal notranslate"><span class="pre">.ahole/refs/remotes/eve/master</span></code>, and in fact, it points to the commit that
she did on the third day; this was commit ‘0a01a0’.  I don’t have this
commit in my <code class="docutils literal notranslate"><span class="pre">.ahole</span></code> directory, so I’ll copy that from
<code class="docutils literal notranslate"><span class="pre">/eves_computer/our_book/.ahole/0a01a0</span></code>.  I look in the <code class="docutils literal notranslate"><span class="pre">info.txt</span></code> file
for that commit, and check what the parent is.  It is ‘7ef41f’.  I check if I
have that, and yes, I have, so I can stop copying stuff from Eve’s directory.</p>
<p>So, what I just did was:</p>
<ul class="simple">
<li><p>Copy Eve’s <em>head</em> references from
<code class="docutils literal notranslate"><span class="pre">/eves_computer/our_book/.ahole/refs/heads</span></code> to my
<code class="docutils literal notranslate"><span class="pre">.ahole/refs/remotes/eve</span></code>.</p></li>
<li><p>For each of the references in <code class="docutils literal notranslate"><span class="pre">.ahole/refs/remotes/eve</span></code>, I check whether
I have the referenced commit, and the parents of that commit, and, if not, I
copy them to <code class="docutils literal notranslate"><span class="pre">.ahole</span></code>.</p></li>
</ul>
<p>We decide to call that two-step sequence - a <em>fetch</em>.</p>
<p>Now I want to look at her version of the book.  I have her head references and
the commits they point to, so I can checkout her latest version. I first get the
commit identifier from <code class="docutils literal notranslate"><span class="pre">.ahole/refs/remotes/eve/master</span></code> - ‘0a01a0’.  Then:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ahole_checkout</span><span class="p">(</span><span class="s1">&#39;0a01a0&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This will put ‘0a01a0’ into <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code>.  I can look at her version of the
book, and decide if I like it.  If I do, then I can do a <em>merge</em>.</p>
<p>What is a merge?  It’s the join of two commits.  First I work out where Eve’s
tree diverged from mine, by going back in her history, following the parents of
the commits.  In this case it’s easy, because the parent commit (‘7ef41f’) of
this commit (‘0a01a0’) is one that is also in my history (the history for my
‘master’ branch).  This most recent shared commit I will call the <em>common
ancestor</em>.  Then I work out the difference between the common ancestor commit
(‘7ef41f’) and this commit (‘0a01a0’) - let’s call that <code class="docutils literal notranslate"><span class="pre">eves_diff</span></code>.</p>
<p>I go back to my own ‘master’ - which turns out to be
(<code class="docutils literal notranslate"><span class="pre">.ahole/refs/heads/master</span></code>) - ‘dfbeda’:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ahole_checkout</span><span class="p">(</span><span class="s1">&#39;master&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This will change <code class="docutils literal notranslate"><span class="pre">.ahole/HEAD</span></code> to be <code class="docutils literal notranslate"><span class="pre">ref:</span> <span class="pre">refs/heads/master</span></code> - and I will
have just got the working tree from <code class="docutils literal notranslate"><span class="pre">.ahole/dfbeda/files</span></code>.  Then I take
<code class="docutils literal notranslate"><span class="pre">eves_diff</span></code> and apply it to my current working tree.  If there were any
conflicts, I resolve them, but in my world, there are no conflicts.  I have a
feeling there may be some later.   That apple pie is making me feel a little
funny.</p>
<p>Finally, I make a new commit, with a new unique ID - say ‘80cc85’, with the
merged working tree.  But, there’s a trick: here the new commit ‘80cc85’ - has
<em>two</em> parents, first - ‘dfbeda’ - the previous commit in my ‘master’, and second
‘0a01a0’ - the last commit in Eve’s master.  Now, the next time I look at Eve’s
tree, I will be able to see that I’ve got her ‘0a01a0’ commit in my own history,
and won’t need to apply it again.</p>
</div>
<div class="section" id="on-the-sixth-day-saving-time-and-space-with-objects">
<h2>On the sixth day - saving time and space with objects<a class="headerlink" href="#on-the-sixth-day-saving-time-and-space-with-objects" title="Permalink to this headline">¶</a></h2>
<p>I am now very happy with <code class="docutils literal notranslate"><span class="pre">ahole</span></code>, but Eve clearly doesn’t think we’ve got it
right yet.</p>
<p>As she’s thinking, she decides to make a couple of illustrations for The Book,
so she adds some photos to her working tree:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── .ahole
│   ...
├── images
│   ├── adam_with_apple.jpg
│   └── lion_with_lamb.jpg
├── chapter1_discussion.txt
├── chapter2.txt
├── chapter1.txt
└── contents.txt
</pre></div>
</div>
<p>As soon as she does this, she realizes what’s wrong with <code class="docutils literal notranslate"><span class="pre">ahole</span></code>.  The photos
are large files.  At the moment, every time we make a commit, we’re copying all
the files into the commit <code class="docutils literal notranslate"><span class="pre">files</span></code> directory to make the snapshot.  With big
files, this is going to lead to many identical copies and lots of wasted space.</p>
<p>Eve realizes that what we need to do, is to make the commit use <em>references</em> to
files, rather than the files themselves.  That way, when the commit has files
that have not changed, it can just point to the unchanged file, rather than
carrying a wasteful copy of the file.</p>
<p>If the commits just store references, we need a way to store the contents of the
files, so they can be referenced.  Maybe we could store the files for our
snapshots in a directory, and use some sort of unique filename so that the
commits can reference that filename?  For example, maybe we could make a
directory in <code class="docutils literal notranslate"><span class="pre">.ahole</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">.</span><span class="n">ahole</span><span class="o">/</span><span class="n">objects</span>
</pre></div>
</div>
<p>and use this directory to store the contents of the files for our snapshots.
Then we could store the commits as something like a table, where the entries
would tell us how to get the matching files from the <code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code>
directory.</p>
<p>We could have some structure for the commits like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>├── .ahole
│   ├── 5d89f8
│   │   ├── info.txt
│   │   └── file_list
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">.ahole/5d89f8/file_list</span></code> would be a list of references to files in the
<code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code> directory, along with the filename that the contents has when
reconstructed back into the snapshot.  For example, maybe <code class="docutils literal notranslate"><span class="pre">file_list</span></code> would
have a series of (object reference, filename) pairs like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">contents_version1</span>            <span class="n">contents</span><span class="o">.</span><span class="n">txt</span>
<span class="n">chapter1_version1</span>            <span class="n">chapter1</span><span class="o">.</span><span class="n">txt</span>
<span class="n">chapter2_version2</span>            <span class="n">chapter2</span><span class="o">.</span><span class="n">txt</span>
<span class="n">chapter3_version1</span>            <span class="n">chapter3</span><span class="o">.</span><span class="n">txt</span>
<span class="n">chapter1_discussion_version1</span> <span class="n">chapter1_discussion</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>These references in the first column could match filenames in the
<code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>│   ├── objects
│   │   ├── chapter1_version1
│   │   ├── chapter2_version1
│   │   ├── chapter2_version2
│   │   ├── chapter3_version1
│   │   ├── chapter1_discussion_version1
│   │   └── contents_version1
</pre></div>
</div>
<p>We could think of the <code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code> directory as a very simple form of
database, where the keys are the filenames, and the file contents are the
values.</p>
<p>We think about this for a while and realize that it’s going to be annoying
trying to find unique names to use as filenames in <code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code>, because
there will be many versions of many files.  For example <code class="docutils literal notranslate"><span class="pre">chapter1_version2</span></code>,
<code class="docutils literal notranslate"><span class="pre">chapter1_version3</span></code> and so on is clearly not going to work, because when Eve
and I work independently, at some point we’re both going to have something like
a <code class="docutils literal notranslate"><span class="pre">chapter1_version3</span></code> in our respective <code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code> directories, but
they will be different, and that will be confusing.</p>
<p>At this stage, Eve reveals that she has some training in computer science.  Of
course I have no idea what that is, or who did the training, but she’s in too
much of a rush to explain that now.   She proposes that we make the filenames
(database keys) by doing <em>hashes</em> of the file contents.  It turns out that
hashing algorithms can take a stream of bytes such as the contents of a file,
and create a string that is near-enough unique to that stream of bytes. That’s
really good, because it means that, if Eve and I have an object with the same
filename (hash) that means it almost certainly contains the exact same contents.</p>
<p>Eve recommends the ‘SHA1’ hashing algorithm, and I’m in no position to disagree
with her.  Now we’ve got a unique string to use as a key for each file.  For
example, we run the SHA1 algorithm over the current book files and we get these:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 38%" />
<col style="width: 63%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Filename</p></th>
<th class="head"><p>SHA1 hash</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>chapter1.txt</p></td>
<td><p>9e398c7cf8d56e960aa7769839cc0c38b8e12f11</p></td>
</tr>
<tr class="row-odd"><td><p>chapter2.txt</p></td>
<td><p>65735b3705284cdf4a66c2e4812ca13cbaa7cd5d</p></td>
</tr>
<tr class="row-even"><td><p>chapter1_discussion.txt</p></td>
<td><p>3c2e09cc43568f13444c075c84b047957f7995a5</p></td>
</tr>
<tr class="row-odd"><td><p>contents.txt</p></td>
<td><p>f31bfa1225f9e0eb6741a0ab1122f8cd2cbedc04</p></td>
</tr>
</tbody>
</table>
<p>If we change the file at all, then the hash changes, and we have a new unique
string and therefore we have a new unique filename with which to store the new
contents. For example, the original version of chapter 2 was a bit shorter, and
had a hash of ‘1cf01a1dfbe135b6132362fa8e17eaefcaf00a7f’.</p>
<p>Now we have got a nice way of making the references that will go into
<code class="docutils literal notranslate"><span class="pre">.ahole/5d89f8/file_list</span></code>.  First we store the file versions in our
<code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code> directory, using their hash values as filenames:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>│   ├── objects
│   │   ├── 9e398c7cf8d56e960aa7769839cc0c38b8e12f11 (chapter1 version 1)
│   │   ├── 1cf01a1dfbe135b6132362fa8e17eaefcaf00a7f (chapter2 version 1)
│   │   ├── 65735b3705284cdf4a66c2e4812ca13cbaa7cd5d (chapter2 version 2)
│   │   ├── 3c2e09cc43568f13444c075c84b047957f7995a5 (chapter1_discussion version 1)
│   │   └── f31bfa1225f9e0eb6741a0ab1122f8cd2cbedc04 (contents version 1)
</pre></div>
</div>
<p>Next we create <code class="docutils literal notranslate"><span class="pre">.ahole/5d89f8/file_list</span></code> with one row per file in our
directory.  Each row contains first - the hash value (and therefore filename in
<code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code>) which allows me to get the file contents, then the type of
thing this is - here a file - and lastly, the filename as it was in the
snapshot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">9e398</span><span class="n">c7cf8d56e960aa7769839cc0c38b8e12f11</span> <span class="n">file</span> <span class="n">chapter1</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">65735</span><span class="n">b3705284cdf4a66c2e4812ca13cbaa7cd5d</span> <span class="n">file</span> <span class="n">chapter2</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">3</span><span class="n">c2e09cc43568f13444c075c84b047957f7995a5</span> <span class="n">file</span> <span class="n">chapter1_discussion</span><span class="o">.</span><span class="n">txt</span>
<span class="n">f31bfa1225f9e0eb6741a0ab1122f8cd2cbedc04</span> <span class="n">file</span> <span class="n">contents</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>Now, what about Eve’s new working tree with the photos in it?  The photos are in
the <code class="docutils literal notranslate"><span class="pre">images</span></code> subdirectory, and we don’t have a way of storing subdirectories
yet.  Aha - why not store directories in the object database too?  Directories
can just be <em>tree</em> files like <code class="docutils literal notranslate"><span class="pre">file_list</span></code>.  <em>tree</em> files are lists, one entry
per row, where each row contains the hash reference for the file contents, the
type of thing it is (tree or file), and the filename as it was in the snapshot.
So, for Eve’s new commit, we’d first store the contents of the two photo files
in the <code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>│   ├── objects
│   │   ├── 82e6792faa893070dcd6fe3e614b6f147be1a0a9 (adam_with_apple.jpg)
│   │   ├── e8b23357995db47e70906d4c7a08114c0c0ba376 (lion_with_lamb.jpg)
│   │   ├── 9e398c7cf8d56e960aa7769839cc0c38b8e12f11 (chapter1 version 1)
</pre></div>
</div>
<p>etc.  Then we make a new <em>tree</em> file called - say - ‘images_listing’ like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">82e6792</span><span class="n">faa893070dcd6fe3e614b6f147be1a0a9</span> <span class="n">file</span> <span class="n">adam_with_apple</span><span class="o">.</span><span class="n">jpg</span>
<span class="n">e8b23357995db47e70906d4c7a08114c0c0ba376</span> <span class="n">file</span> <span class="n">lion_with_lamb</span><span class="o">.</span><span class="n">jpg</span>
</pre></div>
</div>
<p>and we make a hash for that tree file too, and put that into
<code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>│   ├── objects
│   │   ├── be242dba385bc0689be16454e959f4b64c87abce (images_listing)
│   │   ├── 82e6792faa893070dcd6fe3e614b6f147be1a0a9 (adam_with_apple.jpg)
│   │   ├── e8b23357995db47e70906d4c7a08114c0c0ba376 (lion_with_lamb.jpg)
│   │   ├── 9e398c7cf8d56e960aa7769839cc0c38b8e12f11 (chapter1 version 1)
</pre></div>
</div>
<p>etc.  Now maybe our whole commit listing can include files and directories for
the root directory of our project, something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">9e398</span><span class="n">c7cf8d56e960aa7769839cc0c38b8e12f11</span> <span class="n">file</span> <span class="n">chapter1</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">65735</span><span class="n">b3705284cdf4a66c2e4812ca13cbaa7cd5d</span> <span class="n">file</span> <span class="n">chapter2</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">3</span><span class="n">c2e09cc43568f13444c075c84b047957f7995a5</span> <span class="n">file</span> <span class="n">chapter1_discussion</span><span class="o">.</span><span class="n">txt</span>
<span class="n">f31bfa1225f9e0eb6741a0ab1122f8cd2cbedc04</span> <span class="n">file</span> <span class="n">contents</span><span class="o">.</span><span class="n">txt</span>
<span class="n">be242dba385bc0689be16454e959f4b64c87abce</span> <span class="n">tree</span> <span class="n">images</span>
</pre></div>
</div>
<p>Oh - but wait - that’s just a tree listing too, let’s make a hash for that, and
put it into the <code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>│   ├── objects
│   │   ├── e52dc9dbe358c549df65307652ff2709322812b3 (root listing)
│   │   ├── be242dba385bc0689be16454e959f4b64c87abce (images_listing)
│   │   ├── 82e6792faa893070dcd6fe3e614b6f147be1a0a9 (adam_with_apple.jpg)
</pre></div>
</div>
<p>Right - so now our whole commit boils down to our <code class="docutils literal notranslate"><span class="pre">info.txt</span></code> file, and the
hash for the root tree (the one starting ‘e52dc’ above). We can get rid of the
old <code class="docutils literal notranslate"><span class="pre">files</span></code> subdirectory in the commit, and add the hash for the root tree
instead - something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">committer</span> <span class="o">=</span> <span class="n">Eve</span>
<span class="n">message</span> <span class="o">=</span> <span class="n">Adding</span> <span class="n">funny</span> <span class="n">pictures</span>
<span class="n">date</span> <span class="o">=</span> <span class="n">year0</span><span class="o">-</span><span class="n">jan</span><span class="o">-</span><span class="mi">06</span>
<span class="n">root_tree</span> <span class="o">=</span> <span class="n">e52dc9dbe358c549df65307652ff2709322812b3</span>
<span class="n">parent</span> <span class="o">=</span> <span class="mi">0</span><span class="n">a01a0</span>
</pre></div>
</div>
<p>Now we can solve the annoying problem of finding an unique commit id for each
commit.   We just make a hash for the <code class="docutils literal notranslate"><span class="pre">info.txt</span></code> file, and put that into the
<code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code> directory too, as a <em>commit</em> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>│   ├── objects
│   │   ├── 7e0cda8c145b300b519ed28998a31f801b6d626f (latest commit)
│   │   ├── e52dc9dbe358c549df65307652ff2709322812b3 (root listing)
│   │   ├── be242dba385bc0689be16454e959f4b64c87abce (images_listing)
</pre></div>
</div>
<p>The unique id for the commit is the hash for its contents. In this case the
commit id is ‘7e0cda8c145b300b519ed28998a31f801b6d626f’.  Don’t forget that the
hash is more or less unique to the contents, so this commit will have an id that
is unique to the combination of the committer, message, date, root tree hash and
commit parent.  The root tree hash is unique to the contents of the root tree
listing, and the root tree listing contains file hashes, which are in turn
unique to the file contents, so the root tree hash will be unique to the file
contents of the commit.  Thus, the commit id is unique to all the things that go
into the commit, including the contents.  It’s clever isn’t it?</p>
<p>We can now have three types of files in the <code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code> directory -
files, trees, and commits.</p>
<p>OK - so things are now a little more complicated than our previous setup with
file copies, but lots of things have just got much easier.   For example, we can
now get rid of the <code class="docutils literal notranslate"><span class="pre">staging_area</span></code> directory.  The staging area can just be a
single file containing the root tree listing of the snapshot.  Let’s call that
file <code class="docutils literal notranslate"><span class="pre">.ahole/index</span></code>.  Now Eve has done her new commit, that file can just be
the root directory listing of the previous commit (the commit we have just
done):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">9e398</span><span class="n">c7cf8d56e960aa7769839cc0c38b8e12f11</span> <span class="n">file</span> <span class="n">chapter1</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">65735</span><span class="n">b3705284cdf4a66c2e4812ca13cbaa7cd5d</span> <span class="n">file</span> <span class="n">chapter2</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">3</span><span class="n">c2e09cc43568f13444c075c84b047957f7995a5</span> <span class="n">file</span> <span class="n">chapter1_discussion</span><span class="o">.</span><span class="n">txt</span>
<span class="n">f31bfa1225f9e0eb6741a0ab1122f8cd2cbedc04</span> <span class="n">file</span> <span class="n">contents</span><span class="o">.</span><span class="n">txt</span>
<span class="n">be242dba385bc0689be16454e959f4b64c87abce</span> <span class="n">tree</span> <span class="n">images</span>
</pre></div>
</div>
<p>When Eve makes an edit to <code class="docutils literal notranslate"><span class="pre">chapter1.txt</span></code>, instead of copying the file to the
<code class="docutils literal notranslate"><span class="pre">staging_area</span></code> directory, she makes a hash for the new <code class="docutils literal notranslate"><span class="pre">chapter1.txt</span></code>
contents, she stores the new <code class="docutils literal notranslate"><span class="pre">chapter1.txt</span></code> contents in the <code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code>
directory using the hash as a filename, and then she edits the <code class="docutils literal notranslate"><span class="pre">.ahole/index</span></code>
file to point to her new chapter 1 contents instead of the old.  She might
automate this with a small command like <code class="docutils literal notranslate"><span class="pre">ahole_stage</span></code> <a class="footnote-reference brackets" href="#need-hashlib" id="id3">3</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ahole_stage</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="c1"># Get the hash for the file contents</span>
    <span class="n">file_contents</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">file_hash</span> <span class="o">=</span> <span class="n">sha1_hash</span><span class="p">(</span><span class="n">file_contents</span><span class="p">)</span>
    <span class="c1"># (assuming that the new file is going in the root directory)</span>
    <span class="n">new_root_entry</span> <span class="o">=</span> <span class="n">file_hash</span> <span class="o">+</span> <span class="s1">&#39; file &#39;</span> <span class="o">+</span> <span class="n">fname</span>
    <span class="n">root_listing</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="s1">&#39;.ahole/index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">new_root_entry</span> <span class="ow">in</span> <span class="n">root_listing</span><span class="p">:</span>
        <span class="c1"># This exact file contents and filename already present</span>
        <span class="k">return</span>
    <span class="c1"># Make an entry for these file contents in the objects database</span>
    <span class="n">database_fname</span> <span class="o">=</span> <span class="s1">&#39;.ahole/objects/&#39;</span> <span class="o">+</span> <span class="n">file_hash</span>
    <span class="n">file</span><span class="p">(</span><span class="n">database_fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_contents</span><span class="p">)</span>
    <span class="c1"># Write index listing with new entry</span>
    <span class="n">root_listing</span> <span class="o">=</span> <span class="n">root_listing</span> <span class="o">+</span> <span class="n">new_root_entry</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">file</span><span class="p">(</span><span class="s1">&#39;.ahole/index&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">root_listing</span><span class="p">)</span>
</pre></div>
</div>
<p>Making a new commit involves taking the contents of <code class="docutils literal notranslate"><span class="pre">.ahole/index</span></code> and using
it to make a new commit file in <code class="docutils literal notranslate"><span class="pre">.ahole/objects</span></code>.  Using the structure of our
previous <code class="docutils literal notranslate"><span class="pre">ahole_commit</span></code> routine, that might look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ahole_commit</span><span class="p">(</span><span class="n">committer</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="c1"># *** this stuff is the same as before ***</span>
    <span class="c1"># Get previous (parent) commit id from .ahole/HEAD</span>
    <span class="n">head_contents</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="s1">&#39;.ahole/HEAD&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="c1"># Check if this is a reference, de-reference if so</span>
    <span class="c1"># Also, get file into which to write the new commit id</span>
    <span class="k">if</span> <span class="n">head_contents</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ref: &#39;</span><span class="p">):</span>
        <span class="n">head_ref</span> <span class="o">=</span> <span class="n">head_contents</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ref: &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">head_ref_file</span> <span class="o">=</span> <span class="s1">&#39;.ahole/&#39;</span> <span class="o">+</span> <span class="n">head_ref</span>
        <span class="n">head_id</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">head_ref_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">head_ref_file</span> <span class="o">=</span> <span class="s1">&#39;.ahole/HEAD&#39;</span>
        <span class="n">head_id</span> <span class="o">=</span> <span class="n">head_contents</span>
    <span class="c1"># *** the stuff below is different ***</span>
    <span class="c1"># Make root tree entry in objects database from .ahole/index</span>
    <span class="n">index_contents</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="s1">&#39;.ahole/index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">index_hash</span> <span class="o">=</span> <span class="n">sha1_hash</span><span class="p">(</span><span class="n">index_contents</span><span class="p">)</span>
    <span class="n">file</span><span class="p">(</span><span class="s1">&#39;.ahole/objects/&#39;</span> <span class="o">+</span> <span class="n">index_hash</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">index_contents</span><span class="p">)</span>
    <span class="c1"># Make commit information with parent set to HEAD</span>
    <span class="n">info_str</span> <span class="o">=</span> <span class="s1">&#39;committer = &#39;</span> <span class="o">+</span> <span class="n">committer</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s1">&#39;message = &#39;</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s1">&#39;date = &#39;</span> <span class="o">+</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s1">&#39;root_tree = &#39;</span> <span class="o">+</span> <span class="n">index_hash</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">info_str</span> <span class="o">+=</span> <span class="s1">&#39;parent = &#39;</span> <span class="o">+</span> <span class="n">head_id</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="c1"># Write commit file into objects database, with hash</span>
    <span class="n">commit_hash</span> <span class="o">=</span> <span class="n">sha1_hash</span><span class="p">(</span><span class="n">info_str</span><span class="p">)</span>
    <span class="n">file</span><span class="p">(</span><span class="s1">&#39;.ahole/objects/&#39;</span> <span class="o">+</span> <span class="n">commit_hash</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">info_str</span><span class="p">)</span>
    <span class="c1"># Set the current commit file to contain new id</span>
    <span class="n">file</span><span class="p">(</span><span class="n">head_ref_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">commit_hash</span><span class="p">)</span>
</pre></div>
</div>
<p>How about doing a merge?  Remember that, in the bad old days, we had to compare
lots of files between the branches, and the common ancestor?  No more.  Now we
are using the hash file references, all we need to do, is look at the tree
listing.  If the tree listing has the same entry (filename and hash) that means
that the file is identical between the two trees, and we don’t have to load the
contents to check. That makes it very fast to do comparisons between trees that
haven’t changed much.</p>
<p>Eve was right of course.  Now, if we make a new commit, when one file is
changed, all we store is the contents of the file that has changed and a new
tree listing with the updated hash for the changed file.  That makes the storage
for lots and lots of similar trees very efficient.</p>
<p>Someone ought to write this up and give it to the world.  Wait, that’s just us.</p>
</div>
<div class="section" id="on-the-seventh-day-there-was-git">
<h2>On the seventh day - there was git<a class="headerlink" href="#on-the-seventh-day-there-was-git" title="Permalink to this headline">¶</a></h2>
<p>The seventh day is for resting.   You are all done now, and the hard stuff is
over.  In a state of deep inner peace, you can think about all that you’ve
discovered in <em>ahole</em>:</p>
<ul class="simple">
<li><p>A commit refers to a snapshot of the complete set of files for your project</p></li>
<li><p>The staging area (index) defines what will change between your upcoming commit
and the previous commit</p></li>
<li><p>A branch is just a pointer to a commit, that moves when you do another commit.</p></li>
<li><p>Version control is very easy to understand</p></li>
</ul>
<p>You remind yourself that life is very good, because you don’t have to use a
version control system called <em>ahole</em>, you can use a very similar system called
<a class="reference external" href="http://git-scm.com">git</a>.</p>
<p>If you use <a class="reference external" href="http://git-scm.com">git</a>, you’ll notice that you have lots of <em>ahole</em> friends.  You’ll
see git creates a <code class="docutils literal notranslate"><span class="pre">.git</span></code> subdirectory that contains the repository.  You’ll
recognize the <code class="docutils literal notranslate"><span class="pre">.git/objects</span></code> directory containing filenames with SHA1 hashes.
You’ll see that commits have SHA1 hashes.  You’ll recognize the <code class="docutils literal notranslate"><span class="pre">.git/HEAD</span></code>
file and <code class="docutils literal notranslate"><span class="pre">.git/refs/heads</span></code> and <code class="docutils literal notranslate"><span class="pre">.git/refs/tags</span></code> and
<code class="docutils literal notranslate"><span class="pre">.git/refs/heads/master</span></code>. There is a <code class="docutils literal notranslate"><span class="pre">.git/index</span></code> file, and it is the
staging area. <code class="docutils literal notranslate"><span class="pre">.git/index</span></code> is a little more complicated than <code class="docutils literal notranslate"><span class="pre">.ahole/index</span></code>
because it’s adapted to helping with difficult merges, but it’s the same idea.</p>
<p>You now live in the garden of Eden of version control.  Remember to stay away
from that apple tree.</p>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="ahole-git"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">ahole</span></code> might seem a bit rude to you, but I was born in the UK, and,
where I come from, ‘ahole’ is roughly as rude as ‘git’.</p>
</dd>
<dt class="label" id="commit-imports"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>In case you are interested, for the commit and checkout
code to actually run, you would need some python definitions.  First some
standard python imports:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">mkdir</span><span class="p">,</span> <span class="n">listdir</span>
</pre></div>
</div>
<p>Then we need some simple custom commands for deleting our working tree, and
for copying files into the working tree:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">remove</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">isdir</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copyfile</span><span class="p">,</span> <span class="n">copytree</span><span class="p">,</span> <span class="n">rmtree</span>

<span class="k">def</span> <span class="nf">delete_tree</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="c1"># Delete everything in path unless it&#39;s an &#39;.ahole&#39; directory</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">remove</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">isdir</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;.ahole&#39;</span><span class="p">:</span>
                <span class="n">rmtree</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">copy_tree</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">dst_path</span><span class="p">):</span>
    <span class="c1"># Copy everything in src_path to dst_path</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">src_path</span><span class="p">):</span>
        <span class="n">src_name</span> <span class="o">=</span> <span class="n">src_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="n">dst_name</span> <span class="o">=</span> <span class="n">dst_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">src_name</span><span class="p">):</span>
            <span class="n">copyfile</span><span class="p">(</span><span class="n">src_name</span><span class="p">,</span> <span class="n">dst_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">isdir</span><span class="p">(</span><span class="n">src_name</span><span class="p">):</span>
            <span class="n">copytree</span><span class="p">(</span><span class="n">src_name</span><span class="p">,</span> <span class="n">dst_name</span><span class="p">)</span>
</pre></div>
</div>
<p>We also need some definition of <code class="docutils literal notranslate"><span class="pre">make_unique_id()</span></code>.</p>
</dd>
<dt class="label" id="need-hashlib"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p>Now you need to add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">hashlib</span>

<span class="k">def</span> <span class="nf">sha1_hash</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1_hash</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
</pre></div>
</div>
<p>.</p>
</dd>
</dl>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Git foundations</a><ul>
<li><a class="reference internal" href="#on-the-first-day-the-repository-and-the-working-tree">On the first day - the repository and the working tree</a></li>
<li><a class="reference internal" href="#on-the-second-day-staging-and-commits">On the second day - staging and commits</a></li>
<li><a class="reference internal" href="#on-the-third-day-history">On the third day - history</a></li>
<li><a class="reference internal" href="#on-the-fourth-day-references">On the fourth day - references</a></li>
<li><a class="reference internal" href="#on-the-fifth-day-branches-merges-and-remotes">On the fifth day - branches, merges and remotes</a></li>
<li><a class="reference internal" href="#on-the-sixth-day-saving-time-and-space-with-objects">On the sixth day - saving time and space with objects</a></li>
<li><a class="reference internal" href="#on-the-seventh-day-there-was-git">On the seventh day - there was git</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="reading_git_objects.html"
                        title="previous chapter">Reading git objects</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="rebase_without_tears.html"
                        title="next chapter">Rebase without tears</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/foundation.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="rebase_without_tears.html" title="Rebase without tears"
             >next</a> |</li>
        <li class="right" >
          <a href="reading_git_objects.html" title="Reading git objects"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pydagogue 0.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="git.html" >Notes and tutorials on git</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Git foundations</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2009-2016 - Matthew Brett.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.3.
    </div>
  </body>
</html>