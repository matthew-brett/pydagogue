<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>OSX flat packages &mdash; pydagogue 0.2 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="pydagogue 0.2 documentation" href="index.html" />
    <link rel="up" title="General computing" href="computing.html" />
    <link rel="next" title="OSX legacy packaging redux" href="legacy_package_redux.html" />
    <link rel="prev" title="Runtime linking on Mac" href="mac_runtime_link.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="legacy_package_redux.html" title="OSX legacy packaging redux"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="mac_runtime_link.html" title="Runtime linking on Mac"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">pydagogue 0.2 documentation</a> &raquo;</li>
          <li><a href="computing.html" accesskey="U">General computing</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="osx-flat-packages">
<h1>OSX flat packages<a class="headerlink" href="#osx-flat-packages" title="Permalink to this headline">¶</a></h1>
<p>OSX flat packages are single installer files with <tt class="docutils literal"><span class="pre">.pkg</span></tt> file extensions.</p>
<p>They appear to have originated with OSX 10.5.  You can&#8217;t install these files
on OSX &gt; 10.5.</p>
<p>The previous packaging formats were <em>bundles</em> rather than single files:</p>
<dl class="docutils">
<dt>bundle</dt>
<dd>A structured directory hierarchy that stores files in a way that
facilitates their retrieval (see glossary in the <a class="reference external" href="https://developer.apple.com/legacy/library/documentation/DeveloperTools/Conceptual/SoftwareDistribution4/Introduction/Introduction.html">software delivery legacy
guide</a>)</dd>
</dl>
<p>See <a class="reference internal" href="legacy_package_redux.html"><em>OSX legacy packaging redux</em></a> for details.</p>
<p>As far as I know there is no Apple document describing the flat package
format.</p>
<p>You may find these other pages useful as background:</p>
<ul class="simple">
<li>A <a class="reference external" href="http://www.mactech.com/articles/mactech/Vol.26/26.02/TheFlatPackage/index.html">MacTech flat package article</a>.</li>
<li>An introduction to the <a class="reference external" href="http://s.sudre.free.fr/Stuff/Ivanhoe/FLAT.html">flat package format</a>.</li>
<li>A guide on <a class="reference external" href="http://ilostmynotes.blogspot.com/2012/06/mac-os-x-pkg-bom-files-package.html">unpacking flat packages</a> manually.</li>
</ul>
<div class="section" id="flat-packages-in-general">
<h2>Flat packages in general<a class="headerlink" href="#flat-packages-in-general" title="Permalink to this headline">¶</a></h2>
<p>Flat packages are <tt class="docutils literal"><span class="pre">xar</span></tt> archives (see the <tt class="docutils literal"><span class="pre">xar</span></tt> man page).</p>
<p>To see the contents of a flat package, the most convenient command is
<tt class="docutils literal"><span class="pre">pkgutil</span> <span class="pre">--expand</span></tt>, as in:</p>
<div class="highlight-python"><div class="highlight"><pre>pkgutil --expand my.pkg an_output_dir
</pre></div>
</div>
<p>This will unpack product archive (meta-packages) and their component packages,
and allows you to futz with the directory contents in <tt class="docutils literal"><span class="pre">an_output_dir</span></tt> before
reconstituting the package with:</p>
<div class="highlight-python"><div class="highlight"><pre>pkgutil --flatten an_output_dir my.pkg
</pre></div>
</div>
<p>On OSX, <tt class="docutils literal"><span class="pre">tar</span></tt> will unpack xar archives, and will automatically detect that
the archive is in xar format with <tt class="docutils literal"><span class="pre">tar</span> <span class="pre">xf</span> <span class="pre">my.pkg</span></tt>, if you really want to do
the unpacking without <tt class="docutils literal"><span class="pre">pkgutil</span></tt>.</p>
</div>
<div class="section" id="different-package-types">
<h2>Different package types<a class="headerlink" href="#different-package-types" title="Permalink to this headline">¶</a></h2>
<p>Flat packages can be of type:</p>
<ul class="simple">
<li><em>product archive</em> – a meta-package format containing one or more
<em>component packages</em> with an XML file specifying the behavior of the
installer, including system and volume requirement checks giving informative
error messages. See the <tt class="docutils literal"><span class="pre">productbuild</span></tt> man page for more detail.</li>
<li><em>component package</em> – an installer to install one component. Generally
included as part of a <em>product archive</em> but can be used as an installer in
its own right.  A component package installer cannot control the behavior of
the installer, but can abort the install or raise a post-install error
message via <tt class="docutils literal"><span class="pre">preinstall</span></tt> and <tt class="docutils literal"><span class="pre">postinstall</span></tt> scripts.</li>
</ul>
</div>
<div class="section" id="component-installer">
<h2>Component installer<a class="headerlink" href="#component-installer" title="Permalink to this headline">¶</a></h2>
<p>A component installer goes through these stages:</p>
<ol class="arabic simple">
<li>Runs <tt class="docutils literal"><span class="pre">preinstall</span></tt> script if present.  An exit code other than zero aborts
the installation.</li>
<li>Writes payload to one or more locations on the target volume</li>
<li>Runs <tt class="docutils literal"><span class="pre">postinstall</span></tt> script if present.  An exit code other then zero gives
an error message.</li>
</ol>
<p>We start with some component packages that only have scripts and no payload,
to show how they work.</p>
<div class="section" id="component-installer-scripts">
<h3>Component installer scripts<a class="headerlink" href="#component-installer-scripts" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mkdir pkg_examples
<span class="nv">$ </span><span class="nb">cd </span>pkg_examples
<span class="nv">$ </span>mkdir scripts
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># file: scripts/preinstall
#!/bin/sh
echo &quot;Running preinstall&quot; &gt; /tmp/my_preinstall.log
exit 0 # all good
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># file: scripts/postinstall
#!/bin/sh
echo &quot;Running postinstall&quot; &gt; /tmp/my_postinstall.log
exit 0 # all good
</pre></div>
</div>
<p>The scripts need to be executable:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>chmod u+x scripts/*
</pre></div>
</div>
<p>Each package needs a package <em>identifier</em> to identify it to the database of
installed packages on the target system.</p>
<p>You can list the recorded installed packages on target <tt class="docutils literal"><span class="pre">/</span></tt> with:</p>
<div class="highlight-python"><div class="highlight"><pre>pkgutil --pkgs /
</pre></div>
</div>
<p>Build the package with a fake identifier:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pkgbuild --nopayload --scripts scripts --identifier my.fake.pkg my_package.pkg
pkgbuild: Adding top-level preinstall script
pkgbuild: Adding top-level postinstall script
pkgbuild: Wrote package to my_package.pkg
</pre></div>
</div>
<p>Install the package:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo installer -pkg my_package.pkg -target /
installer: Package name is my_package
installer: Installing at base path /
installer: The install was successful.
</pre></div>
</div>
<p>Check the scripts ran by looking for output:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>cat /tmp/my_preinstall.log
<span class="nv">$ </span>cat /tmp/my_postinstall.log
Running preinstall
Running postinstall
</pre></div>
</div>
<p>Exit code other than zero causes the installer to give an error message:</p>
<div class="highlight-python"><div class="highlight"><pre># file: scripts/postinstall
#!/bin/sh
exit 1 # not so good
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pkgbuild --nopayload --scripts scripts --identifier my.fake.pkg my_package.pkg
<span class="nv">$ </span>sudo installer -pkg my_package.pkg -target /
pkgbuild: Adding top-level preinstall script
pkgbuild: Adding top-level postinstall script
pkgbuild: Wrote package to my_package.pkg
installer: Package name is my_package
installer: Installing at base path /
installer: The install failed <span class="o">(</span>The Installer encountered an error that caused the installation to fail. Contact the software manufacturer <span class="k">for </span>assistance.<span class="o">)</span>
</pre></div>
</div>
<p>Fixed if the script is not run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>rm scripts/postinstall
<span class="nv">$ </span>pkgbuild --nopayload --scripts scripts --identifier my.fake.pkg my_package.pkg
<span class="nv">$ </span>sudo installer -pkg my_package.pkg -target /
pkgbuild: Adding top-level preinstall script
pkgbuild: Wrote package to my_package.pkg
installer: Package name is my_package
installer: Installing at base path /
installer: The install was successful.
</pre></div>
</div>
<p>There are some useful environment variables available to the
<tt class="docutils literal"><span class="pre">preinstall</span></tt>, <tt class="docutils literal"><span class="pre">postinstall</span></tt> scripts:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span><span class="c"># Get the default environment when not in preinstall</span>
<span class="nv">$ </span>sudo env &gt; /tmp/my_sudo_envs.log
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># file: scripts/preinstall
#!/bin/sh
env &gt; /tmp/my_preinstall_envs.log
echo &quot;Positional arguments&quot; $@ &gt;&gt; /tmp/my_preinstall_envs.log
exit 0
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>chmod u+x scripts/preinstall
<span class="nv">$ </span>pkgbuild --nopayload --scripts scripts --identifier my.fake.pkg my_package.pkg
<span class="nv">$ </span>sudo installer -pkg my_package.pkg -target /
pkgbuild: Adding top-level preinstall script
pkgbuild: Wrote package to my_package.pkg
installer: Package name is my_package
installer: Installing at base path /
installer: The install was successful.
</pre></div>
</div>
<p>Here are the new environment variables inserted by the installer:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>diff /tmp/my_sudo_envs.log /tmp/my_preinstall_envs.log --old-line-format<span class="o">=</span><span class="s2">&quot;&quot;</span> --unchanged-line-format<span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">INSTALLER_TEMP</span><span class="o">=</span>/private/tmp/PKInstallSandbox.qOCyaT/tmp
<span class="nv">DSTVOLUME</span><span class="o">=</span>/
<span class="nv">TMPDIR</span><span class="o">=</span>/private/tmp/PKInstallSandbox.qOCyaT/tmp
<span class="nv">DSTROOT</span><span class="o">=</span>/
<span class="nv">USER</span><span class="o">=</span>root
<span class="nv">SCRIPT_NAME</span><span class="o">=</span>preinstall
<span class="nv">SHARED_INSTALLER_TEMP</span><span class="o">=</span>/var/folders/zz/zyxvpxvq6csfxvn_n0000000000000/C/PKInstallSandboxManager-shared-tmp
<span class="nv">INSTALLER_SECURE_TEMP</span><span class="o">=</span>/var/folders/zz/zyxvpxvq6csfxvn_n0000000000000/C/PKInstallSandboxManager/14A9609B-07AB-4EE2-B484-D53742655336.activeSandbox/34CE0D58-0EB3-4B74-90EF-3A8EFBF9010D
<span class="nv">PATH</span><span class="o">=</span>/bin:/sbin:/usr/bin:/usr/sbin:/usr/libexec
<span class="nv">PWD</span><span class="o">=</span>/private/tmp/PKInstallSandbox.qOCyaT/Scripts/my.fake.pkg.esr1RU
<span class="nv">INSTALL_PKG_SESSION_ID</span><span class="o">=</span>my.fake.pkg
<span class="nv">PACKAGE_PATH</span><span class="o">=</span>/Users/mb312/dev_trees/pydagogue/pkg_examples/my_package.pkg
<span class="nv">SHLVL</span><span class="o">=</span>1
<span class="nv">COMMAND_LINE_INSTALL</span><span class="o">=</span>1
<span class="nv">_</span><span class="o">=</span>/usr/bin/env
Positional arguments /Users/mb312/dev_trees/pydagogue/pkg_examples/my_package.pkg / / /
</pre></div>
</div>
<p>These appear to be a superset of the environment variables listed for the old
bundle installers at <a class="reference external" href="https://developer.apple.com/legacy/library/documentation/DeveloperTools/Conceptual/SoftwareDistribution4/Install_Operations/Install_Operations.html">install operations</a>.</p>
<div class="section" id="no-payload-no-receipt">
<h4>No payload, no receipt<a class="headerlink" href="#no-payload-no-receipt" title="Permalink to this headline">¶</a></h4>
<p>These &#8220;scripts only&#8221; installers have no payload, and write no package receipt
to the package database:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pkgutil --pkgs / | grep my.fake.pkg
</pre></div>
</div>
</div>
</div>
<div class="section" id="payload">
<h3>Payload<a class="headerlink" href="#payload" title="Permalink to this headline">¶</a></h3>
<p>A flat-package component installer can install one or more bundles to given
output locations on the target filesystem.</p>
<p>There are two ways of specifying payload with target location:</p>
<ul class="simple">
<li>Using a <em>destination root</em>, using <tt class="docutils literal"><span class="pre">--root</span></tt> flag to <tt class="docutils literal"><span class="pre">pkgbuild</span></tt>.  This
analyzes a given directory <tt class="docutils literal"><span class="pre">root-path</span></tt> taking this directory to represent
the root <tt class="docutils literal"><span class="pre">/</span></tt> directory of the target system.  The installer will copy each
directory at <tt class="docutils literal"><span class="pre">root-path</span></tt> to the target system at the same relative
filesystem location.</li>
<li>By individual bundle <em>component</em>, using <tt class="docutils literal"><span class="pre">--component</span></tt> flag to
<tt class="docutils literal"><span class="pre">pkgbuild</span></tt>.  Specify directories to copy, and give their output locations
separately using the <tt class="docutils literal"><span class="pre">--install-location</span></tt> flag.</li>
</ul>
<div class="section" id="destination-root">
<span id="id1"></span><h4>Destination root<a class="headerlink" href="#destination-root" title="Permalink to this headline">¶</a></h4>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mkdir -p my_root/tmp/dir1 my_root/tmp/dir2
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;Interesting info&quot;</span> &gt; my_root/tmp/dir1/file1
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;Compelling story&quot;</span> &gt; my_root/tmp/dir2/file2
<span class="nv">$ </span>tree -a my_root
my_root
└── tmp
    ├── dir1
    │   └── file1
    └── dir2
        └── file2

3 directories, 2 files
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pkgbuild --root my_root --identifier my.fake.pkg my_package.pkg
pkgbuild: Inferring bundle components from contents of my_root
pkgbuild: Wrote package to my_package.pkg
</pre></div>
</div>
<p>Do the install:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo installer -pkg my_package.pkg -target /
installer: Package name is my_package
installer: Installing at base path /
installer: The install was successful.
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>cat /tmp/dir1/file1
<span class="nv">$ </span>cat /tmp/dir2/file2
Interesting info
Compelling story
</pre></div>
</div>
<p>This install did write a package receipt:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pkgutil --pkgs / | grep my.fake.pkg
my.fake.pkg
</pre></div>
</div>
</div>
<div class="section" id="explicit-component">
<span id="id2"></span><h4>Explicit component<a class="headerlink" href="#explicit-component" title="Permalink to this headline">¶</a></h4>
<p>We point to a bundle to install and specify the install location.</p>
<p>In this case the bundle must be a properly formed bundle of some sort.</p>
<p>I&#8217;ll make a debug symbols bundle by doing a tiny compilation with clang:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;int main(int argc, char** argv) { }&quot;</span> &gt; aprogram.c
<span class="nv">$ </span>clang -g aprogram.c -o aprogram
<span class="nv">$ </span>tree aprogram.dSYM
aprogram.dSYM
└── Contents
    ├── Info.plist
    └── Resources
        └── DWARF
            └── aprogram

3 directories, 2 files
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pkgbuild --component aprogram.dSYM --install-location /tmp my_package.pkg
pkgbuild: Adding component at /Users/mb312/dev_trees/pydagogue/pkg_examples/aprogram.dSYM
pkgbuild: Wrote package to my_package.pkg
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo installer -pkg my_package.pkg -target /
installer: Package name is my_package
installer: Upgrading at base path /
installer: The upgrade was successful.
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>tree /tmp/aprogram.dSYM
/tmp/aprogram.dSYM
└── Contents
    ├── Info.plist
    └── Resources
        └── DWARF
            └── aprogram

3 directories, 2 files
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="product-archive">
<h2>Product archive<a class="headerlink" href="#product-archive" title="Permalink to this headline">¶</a></h2>
<p>Component packages give very basic default install.</p>
<p>Product archives allow you to wrap one or more component installs with an
install configuration that includes:</p>
<ul class="simple">
<li>custom welcome, readme, license and conclusion screens;</li>
<li>custom system requirement and volume requirement checks with informative
error messages using javascript code;</li>
<li>ability to customize choices of component packages to install using
javascript code.</li>
</ul>
<p>An XML file named <tt class="docutils literal"><span class="pre">Distribution</span></tt> specifies these options (see <a class="reference external" href="https://developer.apple.com/library/mac/documentation/DeveloperTools/Reference/DistributionDefinitionRef/Chapters/Introduction.html#//apple_ref/doc/uid/TP40005370-CH1-SW1">distribution
definition file</a>).</p>
<div class="section" id="building-product-archives-with-productarchive">
<h3>Building product archives with <tt class="docutils literal"><span class="pre">productarchive</span></tt><a class="headerlink" href="#building-product-archives-with-productarchive" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">productarchive</span></tt> has five modes of action:</p>
<div class="section" id="archive-for-in-app-content">
<h4>Archive for &#8220;in-app&#8221; content<a class="headerlink" href="#archive-for-in-app-content" title="Permalink to this headline">¶</a></h4>
<p>This appears to be something to do with the App Store.  Use the <tt class="docutils literal"><span class="pre">--content</span></tt>
flag for this one.</p>
</div>
<div class="section" id="archive-from-destination-root">
<h4>Archive from destination root<a class="headerlink" href="#archive-from-destination-root" title="Permalink to this headline">¶</a></h4>
<p>Build an archive from a directory where the paths of the files relative to the
<tt class="docutils literal"><span class="pre">--root</span></tt> directory give the output install location on the target volume
(see <a class="reference internal" href="#destination-root"><em>Destination root</em></a>).</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>productbuild --root my_root my_archive.pkg
productbuild: Wrote product to my_archive.pkg
</pre></div>
</div>
</div>
<div class="section" id="archive-from-component-bundle-s-or-package-s">
<h4>Archive from component bundle(s) or package(s)<a class="headerlink" href="#archive-from-component-bundle-s-or-package-s" title="Permalink to this headline">¶</a></h4>
<p>Build a product archive from one or more components by passing:</p>
<ul class="simple">
<li>bundle path(s) with one or more uses of the <tt class="docutils literal"><span class="pre">--component</span></tt> flag (see
<a class="reference internal" href="#explicit-component"><em>Explicit component</em></a>) and / or;</li>
<li>package paths(s) with one or more uses of the <tt class="docutils literal"><span class="pre">--package</span></tt> flag.</li>
</ul>
<p>First build another bundle:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;int main(int argc, char** argv) { }&quot;</span> &gt; aprogram2.c
<span class="nv">$ </span>clang -g aprogram2.c -o aprogram2
</pre></div>
</div>
<p>Build product archive with two component bundles:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>productbuild --component aprogram.dSYM /tmp --component aprogram2.dSYM /tmp my_archive.pkg
productbuild: Adding component at /Users/mb312/dev_trees/pydagogue/pkg_examples/aprogram.dSYM
productbuild: Adding component at /Users/mb312/dev_trees/pydagogue/pkg_examples/aprogram2.dSYM
productbuild: Wrote product to my_archive.pkg
</pre></div>
</div>
<p>Make bundles into component packages:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pkgbuild --component aprogram.dSYM --install-location /tmp aprogram.pkg
<span class="nv">$ </span>pkgbuild --component aprogram2.dSYM --install-location /tmp aprogram2.pkg
pkgbuild: Adding component at /Users/mb312/dev_trees/pydagogue/pkg_examples/aprogram.dSYM
pkgbuild: Wrote package to aprogram.pkg
pkgbuild: Adding component at /Users/mb312/dev_trees/pydagogue/pkg_examples/aprogram2.dSYM
pkgbuild: Wrote package to aprogram2.pkg
</pre></div>
</div>
<p>Build product archives from the component packages:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>productbuild --package aprogram.pkg --package aprogram2.pkg my_archive.pkg
productbuild: Wrote product to my_archive.pkg
</pre></div>
</div>
</div>
<div class="section" id="build-a-distribution-file-from-component-bundle-s-packages-s">
<h4>Build a <tt class="docutils literal"><span class="pre">Distribution</span></tt> file from component bundle(s) / packages(s)<a class="headerlink" href="#build-a-distribution-file-from-component-bundle-s-packages-s" title="Permalink to this headline">¶</a></h4>
<p>This builds a template <tt class="docutils literal"><span class="pre">Distribution</span></tt> XML file by analyzing one or more
components in the form of bundles or <tt class="docutils literal"><span class="pre">.pkg</span></tt> files.  Use the <tt class="docutils literal"><span class="pre">--synthesize</span></tt>
flag.</p>
<p>Analyze two component bundles to give a <tt class="docutils literal"><span class="pre">Distribution</span></tt> file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>productbuild --synthesize --component aprogram.dSYM --component aprogram2.dSYM Distribution-1
productbuild: Adding component at /Users/mb312/dev_trees/pydagogue/pkg_examples/aprogram.dSYM
productbuild: Inferred install-location of /Users/mb312/dev_trees/pydagogue/pkg_examples
productbuild: Adding component at /Users/mb312/dev_trees/pydagogue/pkg_examples/aprogram2.dSYM
productbuild: Inferred install-location of /Users/mb312/dev_trees/pydagogue/pkg_examples
productbuild: Wrote synthesized distribution to Distribution-1
</pre></div>
</div>
<p>Analyze two component packages to give a <tt class="docutils literal"><span class="pre">Distribution</span></tt> file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>productbuild --synthesize --package aprogram.pkg --package aprogram2.pkg Distribution-2
productbuild: Wrote synthesized distribution to Distribution-2
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>cat Distribution-2
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span> <span class="nv">standalone</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>?&gt;
&lt;installer-gui-script <span class="nv">minSpecVersion</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>&gt;
    &lt;pkg-ref <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;com.apple.xcode.dsym.aprogram&quot;</span>/&gt;
    &lt;pkg-ref <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;com.apple.xcode.dsym.aprogram2&quot;</span>/&gt;
    &lt;options <span class="nv">customize</span><span class="o">=</span><span class="s2">&quot;never&quot;</span> require-scripts<span class="o">=</span><span class="s2">&quot;false&quot;</span>/&gt;
    &lt;choices-outline&gt;
        &lt;line <span class="nv">choice</span><span class="o">=</span><span class="s2">&quot;default&quot;</span>&gt;
            &lt;line <span class="nv">choice</span><span class="o">=</span><span class="s2">&quot;com.apple.xcode.dsym.aprogram&quot;</span>/&gt;
            &lt;line <span class="nv">choice</span><span class="o">=</span><span class="s2">&quot;com.apple.xcode.dsym.aprogram2&quot;</span>/&gt;
        &lt;/line&gt;
    &lt;/choices-outline&gt;
    &lt;choice <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;default&quot;</span>/&gt;
    &lt;choice <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;com.apple.xcode.dsym.aprogram&quot;</span> <span class="nv">visible</span><span class="o">=</span><span class="s2">&quot;false&quot;</span>&gt;
        &lt;pkg-ref <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;com.apple.xcode.dsym.aprogram&quot;</span>/&gt;
    &lt;/choice&gt;
    &lt;pkg-ref <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;com.apple.xcode.dsym.aprogram&quot;</span> <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span> <span class="nv">onConclusion</span><span class="o">=</span><span class="s2">&quot;none&quot;</span>&gt;aprogram.pkg&lt;/pkg-ref&gt;
    &lt;choice <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;com.apple.xcode.dsym.aprogram2&quot;</span> <span class="nv">visible</span><span class="o">=</span><span class="s2">&quot;false&quot;</span>&gt;
        &lt;pkg-ref <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;com.apple.xcode.dsym.aprogram2&quot;</span>/&gt;
    &lt;/choice&gt;
    &lt;pkg-ref <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;com.apple.xcode.dsym.aprogram2&quot;</span> <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span> <span class="nv">onConclusion</span><span class="o">=</span><span class="s2">&quot;none&quot;</span>&gt;aprogram2.pkg&lt;/pkg-ref&gt;
&lt;/installer-gui-script&gt;
</pre></div>
</div>
</div>
<div class="section" id="archive-from-distribution-file">
<h4>Archive from <tt class="docutils literal"><span class="pre">Distribution</span></tt> file<a class="headerlink" href="#archive-from-distribution-file" title="Permalink to this headline">¶</a></h4>
<p>Build a product archive from a pre-existing <tt class="docutils literal"><span class="pre">Distribution</span></tt> file, using the
<tt class="docutils literal"><span class="pre">--distribution</span></tt> flag.  The <tt class="docutils literal"><span class="pre">Distribution</span></tt> file refers to pre-existing
component <tt class="docutils literal"><span class="pre">.pkg</span></tt> files.  If these are not in the current directory, you can
give paths to find <tt class="docutils literal"><span class="pre">.pkg</span></tt> files with the <tt class="docutils literal"><span class="pre">--package-path</span></tt> flag.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>productbuild --distribution Distribution-2 my_archive.pkg
productbuild: Wrote product to my_archive.pkg
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="customizing-the-distribution-file">
<h2>Customizing the <tt class="docutils literal"><span class="pre">Distribution</span></tt> file<a class="headerlink" href="#customizing-the-distribution-file" title="Permalink to this headline">¶</a></h2>
<p>See: <a class="reference external" href="https://developer.apple.com/library/mac/documentation/DeveloperTools/Reference/DistributionDefinitionRef/Chapters/Introduction.html#//apple_ref/doc/uid/TP40005370-CH1-SW1">distribution definition file</a> and <a class="reference external" href="https://developer.apple.com/library/mac/documentation/DeveloperTools/Reference/InstallerJavaScriptRef/InstallerJavaScriptRef.pdf">installer javascript reference</a>.</p>
<div class="section" id="adding-system-and-volume-checks">
<h3>Adding system and volume checks<a class="headerlink" href="#adding-system-and-volume-checks" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre># file: distro_check.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;no&quot;?&gt;
&lt;installer-gui-script minSpecVersion=&quot;1&quot;&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram&quot;/&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram2&quot;/&gt;
    &lt;choices-outline&gt;
        &lt;line choice=&quot;default&quot;&gt;
            &lt;line choice=&quot;com.apple.xcode.dsym.aprogram&quot;/&gt;
            &lt;line choice=&quot;com.apple.xcode.dsym.aprogram2&quot;/&gt;
        &lt;/line&gt;
    &lt;/choices-outline&gt;
    &lt;choice id=&quot;default&quot;/&gt;
    &lt;choice id=&quot;com.apple.xcode.dsym.aprogram&quot; visible=&quot;false&quot;&gt;
        &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram&quot;/&gt;
    &lt;/choice&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram&quot; version=&quot;1.0.0&quot; onConclusion=&quot;none&quot;&gt;aprogram.pkg&lt;/pkg-ref&gt;
    &lt;choice id=&quot;com.apple.xcode.dsym.aprogram2&quot; visible=&quot;false&quot;&gt;
        &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram2&quot;/&gt;
    &lt;/choice&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram2&quot; version=&quot;1.0.0&quot; onConclusion=&quot;none&quot;&gt;aprogram2.pkg&lt;/pkg-ref&gt;
    &lt;installation-check script=&quot;installation_check()&quot;/&gt;
    &lt;volume-check script=&quot;volume_check()&quot;/&gt;
    &lt;script&gt;&lt;![CDATA[

function installation_check () {
    // Check 64 bit
    if (! system.sysctl(&#39;hw.cpu64bit_capable&#39;)) {
        // need to set error type
        my.result.type = &quot;Fatal&quot;
        my.result.message = &quot;Installer needs 64 bit&quot;
        return false
    }
    return true
}

function volume_check () {
    // check installed file exists
    log_file = my.target.mountpoint + &#39;tmp/my_postinstall.log&#39;
    if (! system.files.fileExistsAtPath(log_file)) {
        // need to set error type
        my.result.type = &quot;Fatal&quot;
        my.result.message = &quot;No my_postinstall file on volume&quot;
        return false
    }
    return true
}

    ]]&gt;&lt;/script&gt;
&lt;/installer-gui-script&gt;
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>productbuild --distribution distro_check.xml my_archive.pkg
productbuild: Wrote product to my_archive.pkg
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo installer -pkg my_archive.pkg -target /
installer: Package name is 
installer: Upgrading at base path /
installer: The upgrade was successful.
</pre></div>
</div>
<p>Now make the volume check fail:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo rm /tmp/my_postinstall.log
<span class="nv">$ </span>sudo installer -pkg my_archive.pkg -target /
installer: Cannot install on volume / because it is disabled.
installer: No my_postinstall file on volume
</pre></div>
</div>
<p>The volume check gets run on every candidate volume; each volume that passes
the check is eligible for the install.</p>
</div>
<div class="section" id="adding-custom-script-checks">
<h3>Adding custom script checks<a class="headerlink" href="#adding-custom-script-checks" title="Permalink to this headline">¶</a></h3>
<p>You can add custom executable scripts or binaries to run via the javascript
functions such as the volume check and the system check.</p>
<p>You first have to enable the <tt class="docutils literal"><span class="pre">allow-external-scripts</span></tt> option in the
Distribution file XML:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;options allow-external-scripts=&quot;yes&quot;/&gt;
</pre></div>
</div>
<p>This will cause the installer GUI to ask if you want to allow an external
script to check if the software can be installed.</p>
<p>You can then call external programs via the javascript <tt class="docutils literal"><span class="pre">system.run()</span></tt>
function.  The programs you call with <tt class="docutils literal"><span class="pre">system.run</span></tt> either need to be on the
system PATH that the installer uses, or provided in the installer, usually via
the <tt class="docutils literal"><span class="pre">--scripts</span></tt> flag to <tt class="docutils literal"><span class="pre">productbuild</span></tt>.  Here&#8217;s an example of a command
already on the path:</p>
<div class="highlight-python"><div class="highlight"><pre># file: distro_system_run.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;no&quot;?&gt;
&lt;installer-gui-script minSpecVersion=&quot;1&quot;&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram&quot;/&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram2&quot;/&gt;
    &lt;options allow-external-scripts=&quot;yes&quot;/&gt;
    &lt;choices-outline&gt;
        &lt;line choice=&quot;default&quot;&gt;
            &lt;line choice=&quot;com.apple.xcode.dsym.aprogram&quot;/&gt;
            &lt;line choice=&quot;com.apple.xcode.dsym.aprogram2&quot;/&gt;
        &lt;/line&gt;
    &lt;/choices-outline&gt;
    &lt;choice id=&quot;default&quot;/&gt;
    &lt;choice id=&quot;com.apple.xcode.dsym.aprogram&quot; visible=&quot;false&quot;&gt;
        &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram&quot;/&gt;
    &lt;/choice&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram&quot; version=&quot;1.0.0&quot; onConclusion=&quot;none&quot;&gt;aprogram.pkg&lt;/pkg-ref&gt;
    &lt;choice id=&quot;com.apple.xcode.dsym.aprogram2&quot; visible=&quot;false&quot;&gt;
        &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram2&quot;/&gt;
    &lt;/choice&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram2&quot; version=&quot;1.0.0&quot; onConclusion=&quot;none&quot;&gt;aprogram2.pkg&lt;/pkg-ref&gt;
    &lt;installation-check script=&quot;installation_check()&quot;/&gt;
    &lt;script&gt;&lt;![CDATA[

function installation_check () {
    // Run some sh code
    exit_code = system.run(&#39;/bin/sh&#39;, &#39;-c&#39;,
        &#39;echo &quot;Command ran&quot; &gt; /tmp/my_system_run.log; exit 1&#39;)
    if (exit_code != 0) {
        // need to set error type
        my.result.type = &quot;Fatal&quot;
        my.result.message = &quot;Test function failed by design&quot;
        return false
    }
    return true
}

    ]]&gt;&lt;/script&gt;
&lt;/installer-gui-script&gt;
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>productbuild --distribution distro_system_run.xml my_archive.pkg
productbuild: Wrote product to my_archive.pkg
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo installer -pkg my_archive.pkg -target /
installer: Error - Test <span class="k">function </span>failed by design
</pre></div>
</div>
<p>Check the script ran:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>cat /tmp/my_system_run.log
Command ran
</pre></div>
</div>
<p>Here&#8217;s an example of a custom script:</p>
<div class="highlight-python"><div class="highlight"><pre># file: distro_custom_run.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;no&quot;?&gt;
&lt;installer-gui-script minSpecVersion=&quot;1&quot;&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram&quot;/&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram2&quot;/&gt;
    &lt;options allow-external-scripts=&quot;yes&quot;/&gt;
    &lt;choices-outline&gt;
        &lt;line choice=&quot;default&quot;&gt;
            &lt;line choice=&quot;com.apple.xcode.dsym.aprogram&quot;/&gt;
            &lt;line choice=&quot;com.apple.xcode.dsym.aprogram2&quot;/&gt;
        &lt;/line&gt;
    &lt;/choices-outline&gt;
    &lt;choice id=&quot;default&quot;/&gt;
    &lt;choice id=&quot;com.apple.xcode.dsym.aprogram&quot; visible=&quot;false&quot;&gt;
        &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram&quot;/&gt;
    &lt;/choice&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram&quot; version=&quot;1.0.0&quot; onConclusion=&quot;none&quot;&gt;aprogram.pkg&lt;/pkg-ref&gt;
    &lt;choice id=&quot;com.apple.xcode.dsym.aprogram2&quot; visible=&quot;false&quot;&gt;
        &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram2&quot;/&gt;
    &lt;/choice&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram2&quot; version=&quot;1.0.0&quot; onConclusion=&quot;none&quot;&gt;aprogram2.pkg&lt;/pkg-ref&gt;
    &lt;installation-check script=&quot;installation_check()&quot;/&gt;
    &lt;script&gt;&lt;![CDATA[

function installation_check () {
    // Run a custom script
    exit_code = system.run(&#39;my_test_cmd.sh&#39;, &#39;args&#39;, &#39;I&#39;, &#39;passed&#39;);
    if (exit_code != 0) {
        // need to set error type
        my.result.type = &quot;Fatal&quot;
        my.result.message = &quot;Test function failed by design&quot;
        return false
    }
    return true
}

    ]]&gt;&lt;/script&gt;
&lt;/installer-gui-script&gt;
</pre></div>
</div>
<p>Make a directory to contain the test script:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mkdir archive_scripts
</pre></div>
</div>
<p>Use test script to look for any interesting environment variables available to
the custom script:</p>
<div class="highlight-python"><div class="highlight"><pre># file: archive_scripts/my_test_cmd.sh
#!/bin/sh
env &gt; /tmp/my_custom_envs.log
echo &quot;Positional arguments&quot; $@ &gt;&gt; /tmp/my_custom_envs.log
exit 2
</pre></div>
</div>
<p>The script must be executable:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>chmod u+x archive_scripts/my_test_cmd.sh
</pre></div>
</div>
<p>Build the product archive with <tt class="docutils literal"><span class="pre">--scripts</span></tt> flag:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>productbuild --distribution distro_custom_run.xml --scripts archive_scripts my_archive.pkg
productbuild: Wrote product to my_archive.pkg
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo installer -pkg my_archive.pkg -target /
installer: Error - Test <span class="k">function </span>failed by design
</pre></div>
</div>
<p>Check the environment variables available to the custom script.  We already
have <tt class="docutils literal"><span class="pre">/tmp/my_sudo_envs.log</span></tt> with the standard environment variables
available as root, so look for the difference:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>diff /tmp/my_sudo_envs.log /tmp/my_custom_envs.log --old-line-format<span class="o">=</span><span class="s2">&quot;&quot;</span> --unchanged-line-format<span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">SHELL</span><span class="o">=</span>/bin/bash
<span class="nv">USER</span><span class="o">=</span>root
<span class="nv">SUDO_USER</span><span class="o">=</span>mb312
<span class="nv">SUDO_UID</span><span class="o">=</span>501
<span class="nv">__CF_USER_TEXT_ENCODING</span><span class="o">=</span>0x0:0:0
<span class="nv">USERNAME</span><span class="o">=</span>root
<span class="nv">MAIL</span><span class="o">=</span>/var/mail/root
<span class="nv">PWD</span><span class="o">=</span>/private/var/folders/zz/zyxvpxvq6csfxvn_n0000000000000/T/com.apple.install.lxPMQWrm
<span class="nv">SHLVL</span><span class="o">=</span>1
<span class="nv">SUDO_COMMAND</span><span class="o">=</span>/usr/sbin/installer -pkg my_archive.pkg -target /
<span class="nv">COMMAND_LINE_INSTALL</span><span class="o">=</span>1
<span class="nv">DISPLAY</span><span class="o">=</span>/tmp/launch-MOZEmv/org.macosforge.xquartz:0
<span class="nv">_</span><span class="o">=</span>/usr/bin/env
Positional arguments args I passed
</pre></div>
</div>
<p>There do not seem to be any environment variables to tell us where the
installer <tt class="docutils literal"><span class="pre">.pkg</span></tt> file is.  Here we can work out which volume the installer
is installing to with the <tt class="docutils literal"><span class="pre">SUDO_COMMAND</span></tt> variable, but this will only work
for command line installs - the installer GUI does not set this variable.</p>
</div>
<div class="section" id="customizing-the-installer-pages">
<h3>Customizing the installer pages<a class="headerlink" href="#customizing-the-installer-pages" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference external" href="https://developer.apple.com/library/mac/documentation/DeveloperTools/Reference/DistributionDefinitionRef/Chapters/Introduction.html#//apple_ref/doc/uid/TP40005370-CH1-SW1">distribution definition file</a> for details.</p>
<p>You can customize these pages:</p>
<ul class="simple">
<li>Welcome (<tt class="docutils literal"><span class="pre">&lt;welcome</span> <span class="pre">...</span> <span class="pre">/&gt;</span></tt> element)</li>
<li>Readme  (<tt class="docutils literal"><span class="pre">&lt;readme</span> <span class="pre">...</span> <span class="pre">/&gt;</span></tt>)</li>
<li>License (<tt class="docutils literal"><span class="pre">&lt;license</span> <span class="pre">...</span> <span class="pre">/&gt;</span></tt>)</li>
<li>Conclusion (<tt class="docutils literal"><span class="pre">&lt;conclusion</span> <span class="pre">...</span> <span class="pre">/&gt;</span></tt>)</li>
</ul>
<p>To do this, you specify the filename containing the custom text, and the
format of the file.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;welcome file=&quot;welcome.html&quot; mime-type=&quot;text/html&quot;/&gt;
</pre></div>
</div>
<p>The file should be in the <tt class="docutils literal"><span class="pre">Resources/&lt;language&gt;.lproj</span></tt> directory of the
installer <tt class="docutils literal"><span class="pre">.pkg</span></tt>, where <tt class="docutils literal"><span class="pre">&lt;language&gt;</span></tt> is a language like &#8220;English&#8221;,
&#8220;French&#8221; or &#8220;Spanish&#8221;, or shorthand for these such as &#8220;en&#8221;, &#8220;fr&#8221;, &#8220;es&#8221;.  Can
you can provide a <tt class="docutils literal"><span class="pre">Resources</span></tt> directory with the <tt class="docutils literal"><span class="pre">--resources</span></tt> flag to
<tt class="docutils literal"><span class="pre">productbuild</span></tt>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mkdir -p my_resources/English.lproj
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># file: my_resources/English.lproj/welcome.html
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=iso-8859-1&quot;&gt;
    &lt;title&gt;Install my_archive &lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;font face=&quot;Helvetica&quot;&gt;
&lt;b&gt;Welcome to the &lt;i&gt;my_archive&lt;/i&gt; installer&lt;/b&gt;
&lt;p&gt;
This installer will install &lt;i&gt;my_archive&lt;/i&gt; on your computer.
&lt;/font&gt;
&lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># file: distro_welcome.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;no&quot;?&gt;
&lt;installer-gui-script minSpecVersion=&quot;1&quot;&gt;
    &lt;welcome file=&quot;welcome.html&quot; mime-type=&quot;text/html&quot;/&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram&quot;/&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram2&quot;/&gt;
    &lt;choices-outline&gt;
        &lt;line choice=&quot;default&quot;&gt;
            &lt;line choice=&quot;com.apple.xcode.dsym.aprogram&quot;/&gt;
            &lt;line choice=&quot;com.apple.xcode.dsym.aprogram2&quot;/&gt;
        &lt;/line&gt;
    &lt;/choices-outline&gt;
    &lt;choice id=&quot;default&quot;/&gt;
    &lt;choice id=&quot;com.apple.xcode.dsym.aprogram&quot; visible=&quot;false&quot;&gt;
        &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram&quot;/&gt;
    &lt;/choice&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram&quot; version=&quot;1.0.0&quot; onConclusion=&quot;none&quot;&gt;aprogram.pkg&lt;/pkg-ref&gt;
    &lt;choice id=&quot;com.apple.xcode.dsym.aprogram2&quot; visible=&quot;false&quot;&gt;
        &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram2&quot;/&gt;
    &lt;/choice&gt;
    &lt;pkg-ref id=&quot;com.apple.xcode.dsym.aprogram2&quot; version=&quot;1.0.0&quot; onConclusion=&quot;none&quot;&gt;aprogram2.pkg&lt;/pkg-ref&gt;
&lt;/installer-gui-script&gt;
</pre></div>
</div>
<p>We use the <tt class="docutils literal"><span class="pre">--resources</span></tt> flag to add the resources directory:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>productbuild --distribution distro_welcome.xml --resources my_resources my_archive.pkg
productbuild: Wrote product to my_archive.pkg
</pre></div>
</div>
<p>The welcome won&#8217;t show up in the command line install, so you need to run this
installer via the GUI to see the new text.</p>
<p>I used an HTML file here, and that works as expected, for me at least.  There
are many installers that use <tt class="docutils literal"><span class="pre">.rtf</span></tt> files instead of HTML, but I heard a
rumor that <tt class="docutils literal"><span class="pre">productbuild</span></tt> does not deal with these correctly. If you want to
use rich text format files with <tt class="docutils literal"><span class="pre">productbuild</span></tt>, you might have to do some
post-processing of your installer with – <tt class="docutils literal"><span class="pre">pkgutil</span> <span class="pre">--expand</span> <span class="pre">my_archive.pkg</span>
<span class="pre">out_dir</span></tt>; (futz); <tt class="docutils literal"><span class="pre">pkgutil</span> <span class="pre">--flatten</span> <span class="pre">out_dir</span> <span class="pre">my_archive.pkg</span></tt>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">OSX flat packages</a><ul>
<li><a class="reference internal" href="#flat-packages-in-general">Flat packages in general</a></li>
<li><a class="reference internal" href="#different-package-types">Different package types</a></li>
<li><a class="reference internal" href="#component-installer">Component installer</a><ul>
<li><a class="reference internal" href="#component-installer-scripts">Component installer scripts</a><ul>
<li><a class="reference internal" href="#no-payload-no-receipt">No payload, no receipt</a></li>
</ul>
</li>
<li><a class="reference internal" href="#payload">Payload</a><ul>
<li><a class="reference internal" href="#destination-root">Destination root</a></li>
<li><a class="reference internal" href="#explicit-component">Explicit component</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#product-archive">Product archive</a><ul>
<li><a class="reference internal" href="#building-product-archives-with-productarchive">Building product archives with <tt class="docutils literal"><span class="pre">productarchive</span></tt></a><ul>
<li><a class="reference internal" href="#archive-for-in-app-content">Archive for &#8220;in-app&#8221; content</a></li>
<li><a class="reference internal" href="#archive-from-destination-root">Archive from destination root</a></li>
<li><a class="reference internal" href="#archive-from-component-bundle-s-or-package-s">Archive from component bundle(s) or package(s)</a></li>
<li><a class="reference internal" href="#build-a-distribution-file-from-component-bundle-s-packages-s">Build a <tt class="docutils literal"><span class="pre">Distribution</span></tt> file from component bundle(s) / packages(s)</a></li>
<li><a class="reference internal" href="#archive-from-distribution-file">Archive from <tt class="docutils literal"><span class="pre">Distribution</span></tt> file</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#customizing-the-distribution-file">Customizing the <tt class="docutils literal"><span class="pre">Distribution</span></tt> file</a><ul>
<li><a class="reference internal" href="#adding-system-and-volume-checks">Adding system and volume checks</a></li>
<li><a class="reference internal" href="#adding-custom-script-checks">Adding custom script checks</a></li>
<li><a class="reference internal" href="#customizing-the-installer-pages">Customizing the installer pages</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="mac_runtime_link.html"
                        title="previous chapter">Runtime linking on Mac</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="legacy_package_redux.html"
                        title="next chapter">OSX legacy packaging redux</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/flat_packages.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="legacy_package_redux.html" title="OSX legacy packaging redux"
             >next</a> |</li>
        <li class="right" >
          <a href="mac_runtime_link.html" title="Runtime linking on Mac"
             >previous</a> |</li>
        <li><a href="index.html">pydagogue 0.2 documentation</a> &raquo;</li>
          <li><a href="computing.html" >General computing</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009, 2010 - Matthew Brett.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>